<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .auth-form {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .auth-form.visible {
            opacity: 1;
        }

        .date-input-container {
            position: relative;
        }

        .date-input-container input[type="date"] {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            z-index: 1;
            cursor: pointer;
        }

        .date-input-container input[type="text"] {
            background-color: white;
            cursor: pointer;
        }

        /* Hide the clear button in Edge */
        .date-input-container input[type="date"]::-ms-clear {
            display: none;
        }

        /* Hide the calendar picker indicator */
        .date-input-container input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <!-- Loading indicator -->
    <div id="loadingIndicator" class="text-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-4"></div>
        <p class="text-gray-600">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...</p>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-md">
        <form id="authForm" class="auth-form bg-white p-8 rounded-lg shadow-md space-y-6" style="display: none;"
            method="POST" autocomplete="on" novalidate>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>

            <input type="text" name="username" autocomplete="username" style="display:none">

            <div class="space-y-4">
                <div>
                    <label for="lastname" class="block text-sm font-medium text-gray-700">–ü—Ä—ñ–∑–≤–∏—â–µ</label>
                    <input type="text" id="lastname" name="lastname" autocomplete="section-personal family-name"
                        required data-error="–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>

                <div>
                    <label for="firstname" class="block text-sm font-medium text-gray-700">–Ü–º º—è</label>
                    <input type="text" id="firstname" name="firstname" autocomplete="section-personal given-name"
                        required data-error="–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º'—è"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>

                <div>
                    <label for="patronym" class="block text-sm font-medium text-gray-700">–ü–æ –±–∞—Ç—å–∫–æ–≤—ñ</label>
                    <input type="text" id="patronym" name="patronym" autocomplete="section-personal additional-name"
                        required data-error="–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø–æ –±–∞—Ç—å–∫–æ–≤—ñ"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                </div>

                <div class="date-input-container">
                    <label for="birthdate" class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                    <div class="relative mt-1">
                        <input type="text" id="birthdate-display" placeholder="–î–î.–ú–ú.–†–†–†–†" readonly
                            class="block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer">
                        <input type="date" id="birthdate" name="birthdate" required min="1940-01-01" max="2024-12-31"
                            data-error="–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è" class="cursor-pointer">
                    </div>
                </div>
            </div>

            <div>
                <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    –ü–æ—á–∞—Ç–∏
                </button>
            </div>

            <!-- Hash Generation Section -->
            <div id="hashGenSection" class="hidden space-y-4 mt-4 pt-4 border-t border-gray-200">
                <button type="button" id="generateHashBtn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    –°—Ç–≤–æ—Ä–∏—Ç–∏ –•–µ—à
                </button>

                <div id="hashResult" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π —Ö–µ—à:</label>
                    <div class="flex gap-2">
                        <input type="text" id="hashOutput" readonly
                            class="block w-full rounded-md border border-gray-300 px-3 py-2 bg-gray-50 text-sm">
                        <button type="button" id="copyHashBtn"
                            class="px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            üìã
                        </button>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="hidden text-red-600 text-sm text-center"></div>
        </form>
    </div>

    <script>
        // Initialize form elements
        const birthdateInput = document.getElementById('birthdate');
        const birthdateDisplay = document.getElementById('birthdate-display');
        const authForm = document.getElementById('authForm');

        // Format date for hash calculation
        function formatDateForHash(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // Hash generation
        function generateHash() {
            const firstname = document.getElementById('firstname').value.trim().toLowerCase();
            const lastname = document.getElementById('lastname').value.trim().toLowerCase();
            const patronym = document.getElementById('patronym').value.trim().toLowerCase();
            const birthdate = birthdateInput.value;

            if (!firstname || !lastname || !patronym || !birthdate) {
                showError("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è");
                return null;
            }

            // Format date as DD.MM.YYYY
            const formattedDate = formatDateForHash(birthdate);
            const dataString = `${firstname}|${lastname}|${patronym}|${formattedDate}`;
            return CryptoJS.SHA256(dataString).toString();
        }

        // Initialize the form
        function initializeForm() {
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (typeof isAuthValid === 'function' && isAuthValid()) {
                window.location.href = 'app.html';
                return;
            }

            loadingIndicator.style.display = 'none';
            authForm.style.display = 'block';
            setTimeout(() => {
                authForm.classList.add('visible');
            }, 50);

            const urlParams = new URLSearchParams(window.location.search);
            const isSetupMode = urlParams.get('setup') === 'true';
            if (isSetupMode) {
                document.getElementById('hashGenSection').classList.remove('hidden');
            }
        }

        // Custom validation messages
        document.querySelectorAll('input[required]').forEach(input => {
            input.addEventListener('invalid', function (e) {
                e.preventDefault();
                this.setCustomValidity(this.dataset.error || '–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —Ü–µ –ø–æ–ª–µ');
            });

            input.addEventListener('input', function (e) {
                this.setCustomValidity('');
            });
        });

        // Date input handling
        birthdateInput.addEventListener('change', function (e) {
            if (this.value) {
                const date = new Date(this.value);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                birthdateDisplay.value = `${day}.${month}.${year}`;

                // Validate future dates
                const today = new Date();
                if (date > today) {
                    this.setCustomValidity('–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É');
                    showError('–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É');
                } else {
                    this.setCustomValidity('');
                }
            } else {
                birthdateDisplay.value = '';
            }
        });

        // Open date picker when clicking the display input
        birthdateDisplay.addEventListener('click', function () {
            birthdateInput.showPicker();
        });

        // Handle form submission
        authForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const hash = generateHash();
            if (!hash) return;

            if (typeof authorizedHashes !== 'undefined' && authorizedHashes.includes(hash.toLowerCase())) {
                if (typeof storeAuthData === 'function') {
                    storeAuthData(hash);
                }
                window.location.href = 'app.html';
            } else {
                showError("–ù–∞ –∂–∞–ª—å, –≤–∏ –Ω–µ –º–∞—î—Ç–µ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü—å–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É");
            }
        });

        // Hash generation in setup mode
        const generateHashBtn = document.getElementById('generateHashBtn');
        if (generateHashBtn) {
            generateHashBtn.addEventListener('click', function (e) {
                e.preventDefault();

                const hash = generateHash();
                if (!hash) return;

                const hashOutput = document.getElementById('hashOutput');
                hashOutput.value = hash;
                document.getElementById('hashResult').classList.remove('hidden');
            });

            // Hash copying
            document.getElementById('copyHashBtn').addEventListener('click', function () {
                const hashOutput = document.getElementById('hashOutput');
                hashOutput.select();
                document.execCommand('copy');

                this.textContent = '‚úì';
                setTimeout(() => {
                    this.textContent = 'üìã';
                }, 1000);
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Initialize form on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForm);
        } else {
            initializeForm();
        }
    </script>
</body>

</html>
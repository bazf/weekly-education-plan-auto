<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è">
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .auth-form {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .auth-form.visible {
            opacity: 1;
        }

        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error input {
            border-color: #dc2626;
        }

        .field-error .error-message {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <!-- Loading indicator -->
    <div id="loadingIndicator" class="text-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-4"></div>
        <p class="text-gray-600">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...</p>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-md">
        <form id="authForm" class="auth-form bg-white p-8 rounded-lg shadow-md space-y-6" style="display: none;"
            method="POST" autocomplete="on" novalidate>
            <h2 class="text-2xl font-bold text-gray-900 mb-6">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
            <p class="text-sm text-gray-600 mb-6">–í–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î—Ç–µ, —â–æ –í–∏ –≤–≤–µ–ª–∏ –≤–ª–∞—Å–Ω—ñ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ —Ç–∞ –í–∏ –Ω–µ—Å–µ—Ç–µ
                –ø–æ–≤–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ –¥–æ—Å—Ç–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Ü–∏—Ö –¥–∞–Ω–∏—Ö.</p>

            <input type="text" name="username" autocomplete="username" style="display:none">

            <div class="space-y-4">
                <div>
                    <label for="lastname" class="block text-sm font-medium text-gray-700">–ü—Ä—ñ–∑–≤–∏—â–µ</label>
                    <input type="text" id="lastname" name="lastname" autocomplete="section-personal family-name"
                        required
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <div class="error-message">–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø—Ä—ñ–∑–≤–∏—â–µ</div>
                </div>

                <div>
                    <label for="firstname" class="block text-sm font-medium text-gray-700">–Ü–º º—è</label>
                    <input type="text" id="firstname" name="firstname" autocomplete="section-personal given-name"
                        required
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <div class="error-message">–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º'—è</div>
                </div>

                <div>
                    <label for="patronym" class="block text-sm font-medium text-gray-700">–ü–æ –±–∞—Ç—å–∫–æ–≤—ñ</label>
                    <input type="text" id="patronym" name="patronym" autocomplete="section-personal additional-name"
                        required
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <div class="error-message">–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ø–æ –±–∞—Ç—å–∫–æ–≤—ñ</div>
                </div>

                <div>
                    <label for="birthdate" class="block text-sm font-medium text-gray-700">–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                    <input type="date" id="birthdate" name="birthdate" autocomplete="section-personal bday" required
                        min="1940-01-01" max="2024-12-31" lang="uk"
                        class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <div class="error-message">–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</div>
                </div>
            </div>

            <div>
                <button type="submit"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    –ü–æ—á–∞—Ç–∏
                </button>
            </div>

            <div id="hashGenSection" class="hidden space-y-4 mt-4 pt-4 border-t border-gray-200">
                <button type="button" id="generateHashBtn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    –°—Ç–≤–æ—Ä–∏—Ç–∏ –•–µ—à
                </button>

                <div id="hashResult" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π —Ö–µ—à:</label>
                    <div class="flex gap-2">
                        <input type="text" id="hashOutput" readonly
                            class="block w-full rounded-md border border-gray-300 px-3 py-2 bg-gray-50 text-sm">
                        <button type="button" id="copyHashBtn"
                            class="px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            üìã
                        </button>
                    </div>
                </div>
            </div>

            <div id="errorMessage" class="hidden text-red-600 text-sm text-center"></div>
        </form>
    </div>

    <script src="auth-config.js"></script>
    <script>
        // Form validation
        function validateForm() {
            const form = document.getElementById('authForm');
            const inputs = form.querySelectorAll('input[required]');
            let isValid = true;

            // Clear all previous errors first
            clearAllErrors();

            inputs.forEach(input => {
                if (!input.value.trim()) {
                    isValid = false;
                    input.parentElement.classList.add('field-error');
                }
            });

            return isValid;
        }

        function clearAllErrors() {
            const form = document.getElementById('authForm');
            const errorFields = form.querySelectorAll('.field-error');
            errorFields.forEach(field => {
                field.classList.remove('field-error');
            });
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Format birthdate from input
        function formatDateForHash(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        function generateHash() {
            const firstname = document.getElementById('firstname').value.trim().toLowerCase();
            const lastname = document.getElementById('lastname').value.trim().toLowerCase();
            const patronym = document.getElementById('patronym').value.trim().toLowerCase();
            const birthdate = formatDateForHash(document.getElementById('birthdate').value);

            if (!firstname || !lastname || !patronym || !birthdate) {
                showError("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ");
                return null;
            }

            const dataString = `${firstname}|${lastname}|${patronym}|${birthdate}`;
            return CryptoJS.SHA256(dataString).toString();
        }

        // Initialize the form
        function initializeForm() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const authForm = document.getElementById('authForm');

            if (typeof isAuthValid === 'function' && isAuthValid()) {
                window.location.href = 'app.html';
                return;
            }

            loadingIndicator.style.display = 'none';
            authForm.style.display = 'block';
            setTimeout(() => {
                authForm.classList.add('visible');
            }, 50);

            const urlParams = new URLSearchParams(window.location.search);
            const isSetupMode = urlParams.get('setup') === 'true';
            if (isSetupMode) {
                document.getElementById('hashGenSection').classList.remove('hidden');
            }
        }

        // Initialize as soon as the page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForm);
        } else {
            initializeForm();
        }

        // Handle form submission
        document.getElementById('authForm').addEventListener('submit', function (e) {
            e.preventDefault();

            if (!validateForm()) {
                showError("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è");
                return;
            }

            const hash = generateHash();
            if (!hash) return;

            if (typeof authorizedHashes !== 'undefined' && authorizedHashes.includes(hash)) {
                if (typeof storeAuthData === 'function') {
                    storeAuthData(hash);
                }
                window.location.href = 'app.html';
            } else {
                showError("–ù–∞ –∂–∞–ª—å, –≤–∏ –Ω–µ –º–∞—î—Ç–µ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü—å–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É");
            }
        });

        // Handle hash generation in setup mode
        const generateHashBtn = document.getElementById('generateHashBtn');
        if (generateHashBtn) {
            generateHashBtn.addEventListener('click', function (e) {
                e.preventDefault();

                if (!validateForm()) {
                    showError("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è");
                    return;
                }

                const hash = generateHash();
                if (!hash) return;

                const hashOutput = document.getElementById('hashOutput');
                hashOutput.value = hash;
                document.getElementById('hashResult').classList.remove('hidden');
            });

            // Handle hash copying
            document.getElementById('copyHashBtn').addEventListener('click', function () {
                const hashOutput = document.getElementById('hashOutput');
                hashOutput.select();
                document.execCommand('copy');

                this.textContent = '‚úì';
                setTimeout(() => {
                    this.textContent = 'üìã';
                }, 1000);
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Localize date picker
        const birthdateInput = document.getElementById('birthdate');

        // Set default date placeholder
        birthdateInput.addEventListener('focus', function (e) {
            if (!this.showPicker) {
                this.setAttribute('placeholder', '–î–î.–ú–ú.–†–†–†–†');
            }
        });

        // Custom date validation
        birthdateInput.addEventListener('change', function (e) {
            const date = new Date(this.value);
            const now = new Date();
            const minDate = new Date('1940-01-01');

            if (date > now) {
                this.setCustomValidity('–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É');
                showError('–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É');
            } else if (date < minDate) {
                this.setCustomValidity('–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —Ä–∞–Ω—ñ—à–µ 1940 —Ä–æ–∫—É');
                showError('–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —Ä–∞–Ω—ñ—à–µ 1940 —Ä–æ–∫—É');
            } else {
                this.setCustomValidity('');
            }
        });

        // Format date to Ukrainian locale
        birthdateInput.addEventListener('change', function (e) {
            if (this.value) {
                const date = new Date(this.value);
                const formattedDate = date.toLocaleDateString('uk-UA', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                this.setAttribute('data-formatted', formattedDate);
            }
        });

        // Clear errors when user starts typing
        document.querySelectorAll('input[required]').forEach(input => {
            input.addEventListener('input', function () {
                this.parentElement.classList.remove('field-error');
                document.getElementById('errorMessage').classList.add('hidden');
            });
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>
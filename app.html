<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/weekly-education-plan-auto//manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è">
    <link rel="apple-touch-icon" href="/weekly-education-plan-auto/icons/icon-152x152.png">
    <title>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –∑–∞–Ω—è—Ç—å</title>
    <!-- Tailwind CSS CDN -->
    <script src="3rd-party/js/tailwindcss.js"></script>
    <style>
        [contenteditable="true"]:focus {
            outline: none;
            /* Remove default focus outline */
            border: 3px solid #2563eb !important;
            /* Blue border, adjust color/thickness as needed */
            background-color: rgba(37, 99, 235, 0.05);
            /* Light blue background */
            box-shadow: 0 0 5px rgba(37, 99, 235, 0.3);
            /* Subtle blue glow */
        }

        @media print {
            .no-print {
                display: none !important;
            }

            @page {
                size: A4 landscape;
                margin: 0;
            }

            body {
                margin: 0;
                padding: 0;
                width: 100vw;
            }

            .container {
                margin: 0;
                padding: 0;
                width: 100%;
            }

            .page {
                width: 100%;
                margin: 0;
                page-break-after: always;
                break-inside: avoid;
                page-break-inside: avoid !important;
                display: flex;
                flex-direction: column;
            }

            .page h2 {
                margin: 0 0 4mm 0;
                font-size: 11pt;
                flex: 0 0 auto;
            }

            table {
                width: 100% !important;
                table-layout: fixed;
                border-collapse: collapse;
                font-size: 8pt;
                margin: 0;
                flex: 1;
            }

            thead {
                height: 12%;
            }

            th,
            td {
                padding: 2mm !important;
                word-wrap: break-word;
                font-size: 8pt;
                line-height: 1.2;
                vertical-align: top;
            }

            table td:first-child,
            table th:first-child {
                width: 12%;
                min-width: 120px;
            }

            table td:not(:first-child),
            table th:not(:first-child) {
                width: 12.57%;
            }

            table td:first-child .week-theme-container {
                display: block;
                margin-top: 2mm;
            }

            table td:first-child input {
                width: 90%;
                margin-top: 1mm;
            }

            table td {
                word-break: normal;
                overflow-wrap: break-word;
                white-space: normal;
            }

            input,
            span {
                max-width: 100%;
                word-wrap: break-word;
                font-size: 8pt;
            }

            .week-theme-input {
                margin: 2px 0;
                padding: 1px;
                font-size: 8pt;
            }

            .day-theme-input {
                margin: 1px 0;
                padding: 1px;
                font-size: 8pt;
            }

            .cell-spinner {
                display: none !important;
            }
        }

        #spinnerOverlay {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            padding-top: 20%;
            font-size: 24px;
        }

        .spinnerIcon {
            border: 6px solid #f3f3f3;
            border-radius: 50%;
            border-top: 6px solid #3498db;
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #modelSelectContainer {
            display: none;
        }

        #aiAutofillSection {
            display: none;
        }

        .regenerate-btn {
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            padding: 2px;
            margin-left: 4px;
            display: inline-flex;
            align-items: center;
        }

        .regenerate-btn:hover {
            color: #2563eb;
        }

        .regenerate-btn,
        .week-theme-container:hover .regenerate-btn {
            opacity: 1;
        }

        .cell-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        .cell-content-wrapper {
            min-height: 40px;
        }

        @media print {
            .cell-spinner {
                display: none !important;
            }
        }

        @media print {
            .regenerate-btn {
                display: none !important;
            }
        }

        .week-theme-container {
            display: inline-flex;
            align-items: center;
        }

        /* Additional styles to visually disable the regenerate button */
        .regenerate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Main container with responsive padding -->
    <div class="container mx-auto px-4 py-8">
        <!-- Control panel -->
        <div class="no-print space-y-6 mb-8">
            <!-- Action buttons -->
            <div class="no-print space-y-4 sm:space-y-6 mb-8">
                <div class="flex flex-col space-y-4 sm:flex-row sm:space-y-0 sm:space-x-4 sm:justify-between">
                    <!-- Left group - Instructions and Print -->
                    <div class="flex flex-col space-y-2 sm:flex-row sm:space-y-0 sm:space-x-4">
                        <button id="btnInstructions"
                            class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</span>
                        </button>
                        <button id="btnPrint"
                            class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>–î—Ä—É–∫</span>
                        </button>
                    </div>

                    <!-- Middle group - Clear All and API key -->
                    <div class="flex flex-col space-y-2 sm:flex-row sm:space-y-0 sm:items-center sm:space-x-2">
                        <button id="btnClearAll"
                            class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>–û—á–∏—Å—Ç–∏—Ç–∏ –í—Å–µ</span>
                        </button>
                        <label class="flex items-center justify-center sm:justify-start">
                            <input type="checkbox" id="clearApiKeyCheck" class="h-5 w-5 text-red-600" disabled>
                            <span class="ml-2 text-gray-700">–í–∏–¥–∞–ª–∏—Ç–∏ API –∫–ª—é—á</span>
                        </label>
                    </div>

                    <!-- Right group - Logout -->
                    <div class="flex">
                        <button id="btnLogout"
                            class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>–í–∏–π—Ç–∏ –∑ —Å–∏—Å—Ç–µ–º–∏</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings section -->
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                <h3 class="text-xl font-semibold mb-4">–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –º—ñ—Å—è—Ü—å –ø–ª–∞–Ω—É</h3>

                <!-- Year and month selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="yearSelect" class="block text-sm font-medium text-gray-700">
                            –û–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫:
                        </label>
                        <select id="yearSelect" class="w-full border rounded-md py-2 px-3">
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                            <option value="2031">2031</option>
                            <option value="2032">2032</option>
                            <option value="2033">2033</option>
                            <option value="2034">2034</option>
                            <option value="2035">2035</option>
                            <option value="2036">2036</option>
                            <option value="2037">2037</option>
                            <option value="2038">2038</option>
                            <option value="2039">2039</option>
                            <option value="2040">2040</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label for="monthSelect" class="block text-sm font-medium text-gray-700">
                            –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—è—Ü—å:
                        </label>
                        <select id="monthSelect" class="w-full border rounded-md py-2 px-3">
                            <option value="1">–°—ñ—á–µ–Ω—å</option>
                            <option value="2">–õ—é—Ç–∏–π</option>
                            <option value="3">–ë–µ—Ä–µ–∑–µ–Ω—å</option>
                            <option value="4">–ö–≤—ñ—Ç–µ–Ω—å</option>
                            <option value="5">–¢—Ä–∞–≤–µ–Ω—å</option>
                            <option value="6">–ß–µ—Ä–≤–µ–Ω—å</option>
                            <option value="7">–õ–∏–ø–µ–Ω—å</option>
                            <option value="8">–°–µ—Ä–ø–µ–Ω—å</option>
                            <option value="9">–í–µ—Ä–µ—Å–µ–Ω—å</option>
                            <option value="10">–ñ–æ–≤—Ç–µ–Ω—å</option>
                            <option value="11">–õ–∏—Å—Ç–æ–ø–∞–¥</option>
                            <option value="12">–ì—Ä—É–¥–µ–Ω—å</option>
                        </select>
                    </div>
                </div>

                <button id="generateWeeksBtn"
                    class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 3a1 1 0 00-1 1v4H5a1 1 0 100 2h4v4a1 1 0 102 0v-4h4a1 1 0 100-2h-4V4a1 1 0 00-1-1z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ</span>
                </button>
            </div>

            <!-- AI Settings section -->
            <div class="space-y-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="useAICheck" class="h-5 w-5 text-blue-600">
                    <span class="text-gray-700">–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –®–Ü –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è</span>
                </label>

                <div id="aiAutofillSection" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <h3 class="text-xl font-semibold mb-4">–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∞–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å</h3>

                    <!-- API Key input -->
                    <div class="space-y-2">
                        <label for="apiKeyInput" class="block text-sm font-medium text-gray-700">
                            Google Gemini API Key:
                        </label>
                        <input type="text" id="apiKeyInput" class="w-full border rounded-md py-2 px-3"
                            placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –∫–ª—é—á..." autocomplete="off">
                    </div>

                    <!-- Model selection -->
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="useModelsCheck" class="h-5 w-5 text-blue-600">
                            <span class="text-gray-700">–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–Ω—à—É –º–æ–¥–µ–ª—å –®–Ü</span>
                        </label>

                        <div id="modelSelectContainer" style="display: none;">
                            <label for="modelSelect" class="block text-sm font-medium text-gray-700">
                                –û–±–µ—Ä—ñ—Ç—å –º–æ–¥–µ–ª—å (–û–ø—Ç–∏–º–∞–ª—å–Ω–∞ - –¥–ª—è –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É; –≤—Å—ñ —ñ–Ω—à—ñ - –≤—ñ–¥ –Ω–∞–π—à–≤–∏–¥—à–æ—ó –¥–æ
                                –Ω–∞–π—Ä–æ–∑—É–º–Ω—ñ—à–æ—ó)
                            </label>
                            <select id="modelSelect" class="w-full border rounded-md py-2 px-3">
                                <option value="optimal">üåü –û–ø—Ç–∏–º–∞–ª—å–Ω–∞</option>
                                <option value="gemini-1.5-flash-8b">‚ö°Ô∏è –ë–ª–∏—Å–∫–∞–≤–∏—á–Ω–∞</option>
                                <option value="gemini-1.5-flash">üöÄ –®–≤–∏–¥–∫–∞</option>
                                <option value="gemini-1.5-pro">üí™ –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞</option>
                                <option value="gemini-2.0-flash-exp">üî• –ü–æ—Ç—É–∂–Ω–∞</option>
                                <option value="gemini-2.0-flash-thinking-exp-1219">üß† –†–æ–∑—É–º–Ω–∞</option>
                            </select>
                        </div>
                    </div>

                    <!-- Autofill buttons -->
                    <div class="grid grid-cols-1 gap-4">
                        <button id="autoFillWeekThemesBtn" disabled
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2 disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                            </svg>
                            <span>–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ç–µ–º–∏ —Ç–∏–∂–Ω—ñ–≤</span>
                        </button>

                        <button id="autoFillDayThemesBtn" disabled
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2 disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" />
                            </svg>
                            <span>–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ç–µ–º–∏ –¥–Ω—ñ–≤</span>
                        </button>

                        <button id="autoFillBtn" disabled
                            class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded flex items-center justify-center space-x-2 disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z" />
                                <path d="M3 8a2 2 0 012-2v10h8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" />
                            </svg>
                            <span>–ó–∞–ø–æ–≤–Ω–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º–∏</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table container with horizontal scroll on mobile -->
        <div class="overflow-x-auto">
            <!-- Tables will be generated here -->
        </div>
    </div>

    <!-- Spinner overlay -->
    <div id="spinnerOverlay">
        <div class="spinnerIcon"></div>
        <div>–ó–∞–ø–æ–≤–Ω—é—é, –æ—á—ñ–∫—É–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞!</div>
    </div>

    <script src="auth-config.js"></script>
    <script>
        /****************************************************
         * –ü–ï–†–ï–í–Ü–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á
         ****************************************************/
        (function checkAuth() {
            if (!isAuthValid()) {
                window.location.href = 'index.html';
            }
        })();

        /****************************************************
         * –ó–º—ñ–Ω–Ω–∞ –¥–ª—è –Ω–∞–∑–≤ –º—ñ—Å—è—Ü—ñ–≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é
         ****************************************************/
        const monthNamesUkr = [
            "–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å",
            "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"
        ];

        const MODEL_CONFIG = {
            optimal: {
                name: "üåü –û–ø—Ç–∏–º–∞–ª—å–Ω–∞",
                weekThemes: "gemini-2.0-flash-exp",
                dayThemes: "gemini-2.0-flash-thinking-exp-1219",
                activities: "gemini-2.0-flash-exp"
            },
            models: {
                "gemini-1.5-flash-8b": "‚ö°Ô∏è –ë–ª–∏—Å–∫–∞–≤–∏—á–Ω–∞",
                "gemini-1.5-flash": "üöÄ –®–≤–∏–¥–∫–∞",
                "gemini-1.5-pro": "üí™ –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞",
                "gemini-2.0-flash-exp": "üî• –ü–æ—Ç—É–∂–Ω–∞",
                "gemini-2.0-flash-thinking-exp-1219": "üß† –†–æ–∑—É–º–Ω–∞"
            }
        };

        function setDefaultNextMonth() {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);

            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');

            const nextYear = nextMonth.getFullYear().toString();
            if (yearSelect.querySelector(`option[value="${nextYear}"]`)) {
                yearSelect.value = nextYear;
            }

            const nextMonthNumber = (nextMonth.getMonth() + 1).toString();
            if (monthSelect.querySelector(`option[value="${nextMonthNumber}"]`)) {
                monthSelect.value = nextMonthNumber;
            }

            localStorage.setItem('selectedYear', nextYear);
            localStorage.setItem('selectedMonth', nextMonthNumber);
        }

        async function handleRegeneration(element) {
            // If button is disabled, show modal and exit
            if (element.disabled) {
                if (element.dataset.type === 'day-theme') {
                    showModal('–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø–æ—á–∞—Ç–∫—É –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —Ç–µ–º—É —Ç–∏–∂–Ω—è!', '–£–≤–∞–≥–∞');
                } else if (element.dataset.type === 'activity') {
                    showModal('–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø–æ—á–∞—Ç–∫—É –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —Ç–µ–º—É –¥–Ω—è!', '–£–≤–∞–≥–∞');
                }
                return;
            }

            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showModal('API –∫–ª—é—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –∫–ª—é—á.');
                return;
            }

            const type = element.dataset.type;
            const year = document.getElementById('yearSelect').value;
            const monthIndex = parseInt(document.getElementById('monthSelect').value) - 1;
            const monthName = monthNamesUkr[monthIndex] || "";

            const spinner = document.createElement('div');
            spinner.className = 'cell-spinner';

            let originalContent;
            let contentContainer;
            if (type === 'week-theme' || type === 'day-theme') {
                const container = element.closest('.cell-content-wrapper');
                const input = container.querySelector('input');
                originalContent = input.value;
                container.querySelectorAll('*').forEach(el => el.style.display = 'none');
                contentContainer = container;
                container.appendChild(spinner);
            } else if (type === 'activity') {
                const cell = element.closest('td');
                const span = cell.querySelector('span');
                originalContent = span.textContent;
                span.style.display = 'none';
                contentContainer = span.parentElement;
                contentContainer.insertBefore(spinner, element);
            }

            element.style.display = 'none'; // Hide regenerate button while processing

            try {
                let promptText = '';
                let selectedModel = '';

                if (type === 'week-theme') {
                    selectedModel = getSelectedModel('weekThemes');
                    promptText = `
                –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –æ–¥–Ω—É –∞–∫—Ç—É–∞–ª—å–Ω—É —Ç–µ–º—É –¥–ª—è —Ç–∏–∂–Ω—è —É –¥–∏—Ç—è—á–æ–º—É —Å–∞–¥–æ—á–∫—É –≤ –£–∫—Ä–∞—ó–Ω—ñ 
                –Ω–∞ –ø–µ—Ä—ñ–æ–¥: ${monthName} ${year}.
                –¢–µ–º–∞ –º–∞—î –±—É—Ç–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—é, –∞–ª–µ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ —Å–µ–∑–æ–Ω —Ç–∞ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –≤–∏—Ö–æ–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π –¥–æ—à–∫—ñ–ª—å–Ω–æ–≥–æ –≤—ñ–∫—É.
                –Ø–∫—â–æ –≤ —Ç–∏–∂–Ω—ñ —î –¥–µ—Ä–∂–∞–≤–Ω–µ —Å–≤—è—Ç–æ –£–∫—Ä–∞—ó–Ω–∏ —á–∏ –≤–µ–ª–∏–∫–µ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–µ —Å–≤—è—Ç–æ, –±—É–¥—å –ª–∞—Å–∫–∞, –≤—Ä–∞—Ö—É–π –π–æ–≥–æ –ø—Ä–∏ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—ñ —Ç–µ–º–∏ —Ç–∏–∂–Ω—è.
                –ù–∞–¥–∞–π –ª–∏—à–µ —Ç–µ–º—É, –±–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤.`.trim();
                } else if (type === 'day-theme') {
                    const weekThemeInput = element.closest('.page').querySelector('.week-theme-input');
                    const weekTheme = weekThemeInput ? weekThemeInput.value : '';

                    selectedModel = getSelectedModel('dayThemes');
                    promptText = `
                –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –æ–¥–Ω—É —Ç–µ–º—É –¥–Ω—è –¥–ª—è –¥–∏—Ç—è—á–æ–≥–æ —Å–∞–¥–æ—á–∫—É –≤ –£–∫—Ä–∞—ó–Ω—ñ, 
                –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ —â–æ —Ç–µ–º–∞ —Ç–∏–∂–Ω—è: "${weekTheme}".
                –¢–µ–º–∞ –º–∞—î –±—É—Ç–∏ –ø–æ–≤'—è–∑–∞–Ω–∞ –∑ —Ç–µ–º–æ—é —Ç–∏–∂–Ω—è, –∞–ª–µ –±—É—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—é.
                –ù–∞–¥–∞–π –ª–∏—à–µ —Ç–µ–º—É, –±–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤.`.trim();
                } else if (type === 'activity') {
                    const lineNumber = element.dataset.line;
                    const row = element.closest('tr');
                    const weekThemeInput = element.closest('.page').querySelector('.week-theme-input');
                    const dayThemeInput = row.querySelector('.day-theme-input');
                    const weekTheme = weekThemeInput ? weekThemeInput.value : '';
                    const dayTheme = dayThemeInput ? dayThemeInput.value : '';

                    const weekActivities = Array.from(element.closest('tbody').querySelectorAll('td'))
                        .slice(1)
                        .map(td => td.textContent.trim())
                        .filter(Boolean);

                    selectedModel = getSelectedModel('activities');
                    promptText = `
                –ó–∞–ø—Ä–æ–ø–æ–Ω—É–π –æ–¥–Ω—É —î–¥–∏–Ω—É —É–Ω—ñ–∫–∞–ª—å–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è –æ—Å–≤—ñ—Ç–Ω—å–æ—ó –ª—ñ–Ω—ñ—ó ${lineNumber} —É –¥–∏—Ç—è—á–æ–º—É —Å–∞–¥–æ—á–∫—É.
                ${weekTheme ? `–¢–µ–º–∞ —Ç–∏–∂–Ω—è: "${weekTheme}"` : ''}
                ${dayTheme ? `–¢–µ–º–∞ –¥–Ω—è: "${dayTheme}"` : ''}                
                –ù–∞–∑–≤–∞ —ñ —Å—É—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –º–∞—î –±—É—Ç–∏ –∫–æ—Ä–æ—Ç–∫–æ—é, –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø–æ—è—Å–Ω–µ–Ω—å —â–æ –ø–æ–≤–∏–Ω–Ω—ñ —Ä–æ–±–∏—Ç–∏ –¥—ñ—Ç–∏. 
                –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –º–∞—î –±—É—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—é —ñ –Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ü—å–æ–≥–æ —Ç–∏–∂–Ω—è:
                ${weekActivities.join(', ')}
                –ù–∞–¥–∞–π –ª–∏—à–µ –æ–ø–∏—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ, –±–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤. –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ø–æ–≤–∏–Ω–Ω–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ –æ—Å–≤—ñ—Ç–Ω—é –ª—ñ–Ω—ñ—é, 
                –º–æ–∂–µ –±—É—Ç–∏ —è–∫–∞—Å—å –≥—Ä–∞, —Ä—É—Ö–∞–Ω–∫–∞, —Ç–∞–Ω—Ü—ñ —á–∏ —ñ–Ω—à–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å, —â–æ —Ç–∏ –≤–≤–∞–∂–∞—î—à –¥–æ—Ü—ñ–ª—å–Ω–æ—é –¥–ª—è –¥–æ—à–∫—ñ–ª—å–Ω—è—Ç.`.trim();
                }

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: promptText }]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ API: ${response.status}`);
                }

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts.at(-1).text.trim();

                if (type === 'week-theme' || type === 'day-theme') {
                    const container = element.closest('.cell-content-wrapper');
                    const input = container.querySelector('input');
                    input.value = generatedText;
                    container.querySelectorAll('*').forEach(el => el.style.display = '');
                } else if (type === 'activity') {
                    const cell = element.closest('td');
                    const span = cell.querySelector('span');
                    span.textContent = generatedText;
                    span.style.display = '';
                }

                saveGeneratedPages();
                checkAutoFillAvailability();
                updateRegenerateButtonsState();

            } catch (error) {
                console.error(error);
                showModal("–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó: " + error.message);
                if (type === 'week-theme' || type === 'day-theme') {
                    const container = element.closest('.cell-content-wrapper');
                    const input = container.querySelector('input');
                    input.value = originalContent;
                    container.querySelectorAll('*').forEach(el => el.style.display = '');
                } else if (type === 'activity') {
                    const cell = element.closest('td');
                    const span = cell.querySelector('span');
                    span.textContent = originalContent;
                    span.style.display = '';
                }
            } finally {
                if (spinner.parentNode) {
                    spinner.parentNode.removeChild(spinner);
                }
                element.style.display = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            if (!localStorage.getItem('selectedYear') || !localStorage.getItem('selectedMonth')) {
                setDefaultNextMonth();
            }

            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                document.getElementById('apiKeyInput').value = savedApiKey;
            }

            const savedSelectedYear = localStorage.getItem('selectedYear');
            const savedSelectedMonth = localStorage.getItem('selectedMonth');
            if (savedSelectedYear) {
                document.getElementById('yearSelect').value = savedSelectedYear;
            }
            if (savedSelectedMonth) {
                document.getElementById('monthSelect').value = savedSelectedMonth;
            }

            const savedUseAICheck = localStorage.getItem('useAICheck');
            const useAICheck = document.getElementById('useAICheck');
            const aiAutofillSection = document.getElementById('aiAutofillSection');
            if (savedUseAICheck === 'true') {
                useAICheck.checked = true;
                aiAutofillSection.style.display = 'block';
            }

            const savedModel = localStorage.getItem('selectedModel');
            const useModelsCheck = document.getElementById('useModelsCheck');
            const modelSelectContainer = document.getElementById('modelSelectContainer');
            const modelSelect = document.getElementById('modelSelect');

            if (!savedModel) {
                localStorage.setItem('selectedModel', 'optimal');
                useModelsCheck.checked = false;
                modelSelectContainer.style.display = "none";
                modelSelect.value = 'optimal';
            } else {
                if (savedModel !== 'optimal') {
                    useModelsCheck.checked = true;
                    modelSelectContainer.style.display = "block";
                    modelSelect.value = savedModel;
                } else {
                    useModelsCheck.checked = false;
                    modelSelectContainer.style.display = "none";
                    modelSelect.value = 'optimal';
                }
            }

            const savedPages = localStorage.getItem('allGeneratedPages');
            if (savedPages) {
                document.querySelector('.overflow-x-auto').insertAdjacentHTML('beforeend', savedPages);
                reattachTableHandlers();
                reattachThemeInputHandlers();
                updateRegenerateButtonsState();
            }

            checkAutoFillAvailability();
            updateClearApiKeyCheckbox();
            const hasGeneratedTables = document.querySelectorAll('.page').length > 0;
            if (!hasGeneratedTables) {
                useAICheck.checked = false;
                aiAutofillSection.style.display = 'none';
            }

            updateGenerateButtonState();
        });

        document.addEventListener('click', function (e) {
            if (e.target.closest('.regenerate-btn')) {
                handleRegeneration(e.target.closest('.regenerate-btn'));
            }
        });

        const useAICheck = document.getElementById('useAICheck');
        const aiAutofillSection = document.getElementById('aiAutofillSection');
        useAICheck.addEventListener('change', function () {
            const hasGeneratedTables = document.querySelectorAll('.page').length > 0;

            if (!hasGeneratedTables) {
                this.checked = false;
                showModal('–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—ñ!', '–£–≤–∞–≥–∞');
                return;
            }

            aiAutofillSection.style.display = this.checked ? 'block' : 'none';
            localStorage.setItem('useAICheck', this.checked);
            setTimeout(checkAutoFillAvailability, 0);
        });

        const useModelsCheck = document.getElementById('useModelsCheck');
        const modelSelectContainer = document.getElementById('modelSelectContainer');
        const modelSelect = document.getElementById('modelSelect');

        useModelsCheck.addEventListener('change', function () {
            if (this.checked) {
                modelSelectContainer.style.display = 'block';
            } else {
                modelSelectContainer.style.display = 'none';
                modelSelect.value = 'optimal';
                localStorage.setItem('selectedModel', 'optimal');
            }
        });

        modelSelect.addEventListener('change', function () {
            const selectedValue = this.value;
            localStorage.setItem('selectedModel', selectedValue);
        });

        function getSelectedModel(taskType = 'default') {
            const savedModel = localStorage.getItem('selectedModel') || 'optimal';
            if (savedModel !== 'optimal') {
                return savedModel.trim();
            }
            switch (taskType) {
                case 'weekThemes':
                    return MODEL_CONFIG.optimal.weekThemes;
                case 'dayThemes':
                    return MODEL_CONFIG.optimal.dayThemes;
                case 'activities':
                    return MODEL_CONFIG.optimal.activities;
                default:
                    return MODEL_CONFIG.optimal.weekThemes;
            }
        }

        const clearApiKeyCheck = document.getElementById('clearApiKeyCheck');
        function updateClearApiKeyCheckbox() {
            const apiKey = localStorage.getItem('geminiApiKey');
            clearApiKeyCheck.disabled = !apiKey;
            if (!apiKey) {
                clearApiKeyCheck.checked = false;
            }
        }

        btnClearAll.addEventListener('click', function () {
            if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ —Ç–∞ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É?")) {
                const authData = localStorage.getItem('authData');
                const apiKey = localStorage.getItem('geminiApiKey');

                localStorage.clear();

                if (!clearApiKeyCheck.checked) {
                    if (apiKey) {
                        localStorage.setItem('geminiApiKey', apiKey);
                    }
                }
                if (authData) {
                    localStorage.setItem('authData', authData);
                }
                window.location.reload();
            }
        });

        function saveGeneratedPages() {
            document.querySelectorAll('.cell-spinner').forEach(spinner => {
                spinner.remove();
            });

            document.querySelectorAll('.cell-content-wrapper *').forEach(el => {
                el.style.display = '';
            });

            document.querySelectorAll('.page').forEach(page => {
                page.querySelectorAll('input').forEach(input => {
                    input.setAttribute('value', input.value);
                });

                page.querySelectorAll('td').forEach((td, index) => {
                    if (index > 0) {
                        const contentWrapper = td.querySelector('.flex');
                        if (contentWrapper) {
                            const span = contentWrapper.querySelector('span');
                            const content = span ? span.textContent : '';
                            td.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <span class="flex-grow">${content}</span>
                                    <button class="regenerate-btn flex-shrink-0" data-type="activity" data-line="${index}" title="–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>`;
                        }
                    }
                });
            });

            const pagesHtml = Array.from(document.querySelectorAll('.page'))
                .map(page => page.outerHTML)
                .join('\n');
            localStorage.setItem('allGeneratedPages', pagesHtml);
        }

        function editTableContent(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            table.style.border = '3px solid orange';
            table.querySelectorAll('td, th').forEach(cell => {
                cell.contentEditable = 'true';
                cell.style.border = '2px solid orange';
                cell.style.color = 'orange';
            });
        }

        function saveTableContent(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            table.style.border = '';
            table.querySelectorAll('td, th').forEach(cell => {
                cell.contentEditable = 'false';
                cell.style.border = '';
                cell.style.color = '';
            });
        }

        function reattachTableHandlers() {
            document.querySelectorAll('.editBtn').forEach(btn => {
                btn.disabled = false;
                btn.onclick = function () {
                    const tableId = this.getAttribute('data-table');
                    editTableContent(tableId);
                };
            });

            document.querySelectorAll('.saveBtn').forEach(btn => {
                btn.disabled = false;
                btn.onclick = function () {
                    const tableId = this.getAttribute('data-table');
                    saveTableContent(tableId);
                };
            });
        }

        function updateGenerateButtonState() {
            const hasGeneratedTables = document.querySelectorAll('.page').length > 0;
            const generateWeeksBtn = document.getElementById('generateWeeksBtn');

            if (hasGeneratedTables) {
                generateWeeksBtn.textContent = '–ü–µ—Ä–µ—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ';
                generateWeeksBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                generateWeeksBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
            } else {
                generateWeeksBtn.textContent = '–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ';
                generateWeeksBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                generateWeeksBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            }
        }

        const generateWeeksBtn = document.getElementById('generateWeeksBtn');
        generateWeeksBtn.addEventListener('click', () => {
            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;

            if (!yearSelect || !monthSelect) {
                showModal('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫ —Ç–∞ –º—ñ—Å—è—Ü—å!');
                return;
            }

            localStorage.setItem('selectedYear', yearSelect);
            localStorage.setItem('selectedMonth', monthSelect);

            document.querySelectorAll('.page').forEach(page => page.remove());
            localStorage.removeItem('allGeneratedPages');

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const weeks = getWorkingWeeksOfMonth(year, monthIndex);
            if (weeks.length === 0) {
                showModal('–£ —Ü—å–æ–º—É –º—ñ—Å—è—Ü—ñ –Ω–µ–º–∞—î —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤ (–∑–∞ –ª–æ–≥—ñ–∫–æ—é getWorkingWeeksOfMonth).');
                return;
            }

            const tableContainer = document.querySelector('.overflow-x-auto');

            weeks.forEach((daysArray, index) => {
                const weekNumber = index + 1;
                const firstDateStr = formatDateDDMM(daysArray[0]);
                const lastDateStr = formatDateDDMM(daysArray[daysArray.length - 1]);

                const pageDiv = document.createElement('div');
                pageDiv.classList.add('page', 'mb-8');

                const header = document.createElement('h2');
                header.classList.add('text-lg', 'font-semibold', 'mb-4');
                header.innerHTML = `
    –¢–∏–∂–¥–µ–Ω—å ${weekNumber} (${firstDateStr} ‚Äì ${lastDateStr}).
    <div class="mt-2">
        <label class="inline-flex items-center">
            <div class="week-theme-container cell-content-wrapper">
                <span>–¢–µ–º–∞ —Ç–∏–∂–Ω—è:</span>
                <input type="text" class="week-theme-input border rounded-md ml-2 py-1 px-2" placeholder="–í–∫–∞–∂—ñ—Ç—å —Ç–µ–º—É —Ç–∏–∂–Ω—è">
                <button class="regenerate-btn" data-type="week-theme" title="–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—É —Ç–µ–º—É —Ç–∏–∂–Ω—è">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </label>
    </div>
`;
                pageDiv.appendChild(header);

                const noPrintDiv = document.createElement('div');
                noPrintDiv.classList.add('no-print', 'grid', 'grid-cols-1', 'md:grid-cols-4', 'gap-4', 'mb-4');

                const editBtn = document.createElement('button');
                editBtn.classList.add('editBtn', 'w-full', 'md:col-span-1', 'bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'px-4', 'py-2', 'rounded', 'flex', 'items-center', 'justify-center', 'space-x-2');
                editBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
    </svg>
    <span>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –≤–ª–∞—Å–Ω–æ—Ä—É—á</span>
`;

                const saveBtn = document.createElement('button');
                saveBtn.classList.add('saveBtn', 'w-full', 'md:col-span-1', 'bg-green-500', 'hover:bg-green-600', 'text-white', 'px-4', 'py-2', 'rounded', 'flex', 'items-center', 'justify-center', 'space-x-2');
                saveBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" />
    </svg>
    <span>–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä—É—á–Ω—ñ –∑–º—ñ–Ω–∏ —Ç–∞–±–ª–∏—Ü—ñ</span>
`;
                const tableId = `weekTable${weekNumber}`;
                editBtn.setAttribute('data-table', tableId);
                saveBtn.setAttribute('data-table', tableId);

                noPrintDiv.appendChild(editBtn);
                noPrintDiv.appendChild(saveBtn);
                pageDiv.appendChild(noPrintDiv);

                const table = document.createElement('table');
                table.id = tableId;
                table.classList.add('min-w-full', 'bg-white', 'shadow-md', 'rounded', 'overflow-hidden');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="px-4 py-2">–î–Ω—ñ —Ç–∏–∂–Ω—è (–¢–µ–º–∞ –¥–Ω—è)</th>
                            <th class="px-4 py-2">–û—Å–≤—ñ—Ç–Ω—è –ª—ñ–Ω—ñ—è ¬´–û—Å–æ–±–∏—Å—Ç—ñ—Å—Ç—å –¥–∏—Ç–∏–Ω–∏¬ª</th>
                            <th class="px-4 py-2">–û—Å–≤—ñ—Ç–Ω—è –ª—ñ–Ω—ñ—è ¬´–î–∏—Ç–∏–Ω–∞ –≤ —Å–æ—Ü—ñ—É–º—ñ¬ª</th>
                            <th class="px-4 py-2">–û—Å–≤—ñ—Ç–Ω—è –ª—ñ–Ω—ñ—è ¬´–î–∏—Ç–∏–Ω–∞ –≤ –ø—Ä–∏—Ä–æ–¥–Ω–æ–º—É –¥–æ–≤–∫—ñ–ª–ª—ñ¬ª</th>
                            <th class="px-4 py-2">–û—Å–≤—ñ—Ç–Ω—è –ª—ñ–Ω—ñ—è ¬´–î–∏—Ç–∏–Ω–∞ —É —Å–≤—ñ—Ç—ñ –∫—É–ª—å—Ç—É—Ä–∏¬ª</th>
                            <th class="px-4 py-2">–û—Å–≤—ñ—Ç–Ω—è –ª—ñ–Ω—ñ—è ¬´–ú–æ–≤–ª–µ–Ω–Ω—è –¥–∏—Ç–∏–Ω–∏¬ª</th>
                            <th class="px-4 py-2">–û—Å–≤—ñ—Ç–Ω—è –ª—ñ–Ω—ñ—è ¬´–î–∏—Ç–∏–Ω–∞ –≤ —Å–µ–Ω—Å–æ—Ä–Ω–æ-–º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ–º—É –ø—Ä–æ—Å—Ç–æ—Ä—ñ¬ª</th>
                            <th class="px-4 py-2">–û—Å–≤—ñ—Ç–Ω—è –ª—ñ–Ω—ñ—è ¬´–ì—Ä–∞ –¥–∏—Ç–∏–Ω–∏¬ª</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;

                daysArray.forEach(dayDate => {
                    const ddMM = formatDateDDMM(dayDate);
                    const dayOfWeekName = getDayNameUkr(dayDate.getDay());

                    const row = document.createElement('tr');
                    row.innerHTML = `
    <td class="border px-4 py-2">
        <strong>${ddMM} (${dayOfWeekName})</strong>
        <br>
        <div class="week-theme-container cell-content-wrapper">
            <span>–¢–µ–º–∞ –¥–Ω—è:</span>
            <input type="text" class="day-theme-input border rounded-md mt-1 py-1 px-2" placeholder="–í–∫–∞–∂—ñ—Ç—å —Ç–µ–º—É –¥–Ω—è">
            <button class="regenerate-btn" data-type="day-theme" title="–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—É —Ç–µ–º—É –¥–Ω—è">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </td>
`;

                    for (let i = 1; i <= 7; i++) {
                        row.innerHTML += `
        <td class="border px-4 py-2">
            <div class="flex justify-between items-start">
                <span class="flex-grow"></span>
                <button class="regenerate-btn flex-shrink-0" data-type="activity" data-line="${i}" title="–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </td>
    `;
                    }
                    table.querySelector('tbody').appendChild(row);
                });

                pageDiv.appendChild(table);
                tableContainer.appendChild(pageDiv);
            });

            useAICheck.disabled = false;

            reattachTableHandlers();
            reattachThemeInputHandlers();
            updateRegenerateButtonsState();
            saveGeneratedPages();
            checkAutoFillAvailability();
            updateGenerateButtonState();
            updateRegenerateButtonsState();
        });

        function getWorkingWeeksOfMonth(year, month) {
            const allWorkDays = [];
            let d = new Date(year, month, 1);
            while (d.getMonth() === month) {
                const dayOfWeek = d.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    allWorkDays.push(new Date(d));
                }
                d.setDate(d.getDate() + 1);
            }
            if (allWorkDays.length === 0) return [];

            const weeks = [];
            let currentWeek = [];
            for (let i = 0; i < allWorkDays.length; i++) {
                const dayDate = allWorkDays[i];
                if (dayDate.getDay() === 1 && currentWeek.length > 0) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentWeek.push(dayDate);
            }
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            return weeks;
        }

        function formatDateDDMM(dateObj) {
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            return dd + '.' + mm;
        }

        function getDayNameUkr(dayIndex) {
            const days = [
                '–ù–µ–¥—ñ–ª—è',
                '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫',
                '–í—ñ–≤—Ç–æ—Ä–æ–∫',
                '–°–µ—Ä–µ–¥–∞',
                '–ß–µ—Ç–≤–µ—Ä',
                '–ü‚Äô—è—Ç–Ω–∏—Ü—è',
                '–°—É–±–æ—Ç–∞'
            ];
            return days[dayIndex] || '';
        }

        function reattachThemeInputHandlers() {
            const weekInputs = document.querySelectorAll('.week-theme-input');
            const dayInputs = document.querySelectorAll('.day-theme-input');

            weekInputs.forEach(input => {
                input.addEventListener('input', () => {
                    checkAutoFillAvailability();
                    updateRegenerateButtonsState();
                    saveGeneratedPages();
                });
            });
            dayInputs.forEach(input => {
                input.addEventListener('input', () => {
                    checkAutoFillAvailability();
                    updateRegenerateButtonsState();
                    saveGeneratedPages();
                });
            });
        }

        function areAllThemesFilled() {
            const weekInputs = document.querySelectorAll('.week-theme-input');
            const dayInputs = document.querySelectorAll('.day-theme-input');
            for (let wi of weekInputs) {
                if (!wi.value.trim()) {
                    return false;
                }
            }
            for (let di of dayInputs) {
                if (!di.value.trim()) {
                    return false;
                }
            }
            return true;
        }

        function checkAutoFillAvailability() {
            const autoFillWeekThemesBtn = document.getElementById('autoFillWeekThemesBtn');
            const autoFillDayThemesBtn = document.getElementById('autoFillDayThemesBtn');
            const autoFillBtn = document.getElementById('autoFillBtn');

            const tablesExist = document.querySelectorAll('.page').length > 0;
            if (!useAICheck.checked || !tablesExist) {
                autoFillWeekThemesBtn.disabled = true;
                autoFillDayThemesBtn.disabled = true;
                autoFillBtn.disabled = true;
                return;
            }

            const apiKey = localStorage.getItem('geminiApiKey') || '';
            if (!apiKey.trim()) {
                autoFillWeekThemesBtn.disabled = true;
                autoFillDayThemesBtn.disabled = true;
                autoFillBtn.disabled = true;
                return;
            }

            autoFillWeekThemesBtn.disabled = false;

            let allWeekThemesFilled = true;
            document.querySelectorAll('.week-theme-input').forEach(wi => {
                if (!wi.value.trim()) allWeekThemesFilled = false;
            });
            autoFillDayThemesBtn.disabled = !allWeekThemesFilled;

            autoFillBtn.disabled = !areAllThemesFilled();
        }

        /****************************************************
         * NEW: Update (disable/enable) regenerate buttons based on presence of themes
         ****************************************************/
        function updateRegenerateButtonsState() {
            // For each page (week):
            document.querySelectorAll('.page').forEach(page => {
                const weekThemeInput = page.querySelector('.week-theme-input');
                const weekThemeFilled = (weekThemeInput?.value ?? "").trim().length > 0;

                // If week theme is not filled, disable day-theme regenerate
                const dayThemeBtns = page.querySelectorAll('.regenerate-btn[data-type="day-theme"]');
                dayThemeBtns.forEach(btn => {
                    btn.disabled = !weekThemeFilled;
                });

                // For each row (day):
                page.querySelectorAll('tr').forEach(row => {
                    const dayThemeInput = row.querySelector('.day-theme-input');
                    if (!dayThemeInput) return;
                    const dayThemeFilled = dayThemeInput.value.trim().length > 0;

                    // If day theme is not filled, disable activity regenerate
                    const activityBtns = row.querySelectorAll('.regenerate-btn[data-type="activity"]');
                    activityBtns.forEach(btn => {
                        btn.disabled = !dayThemeFilled;
                    });
                });
            });
        }

        const apiKeyInput = document.getElementById('apiKeyInput');
        let saveTimeout;
        apiKeyInput.addEventListener('input', function () {
            clearTimeout(saveTimeout);
            const keyInput = this.value.trim();

            saveTimeout = setTimeout(() => {
                localStorage.setItem('geminiApiKey', keyInput);
                checkAutoFillAvailability();
                updateClearApiKeyCheckbox();
            }, 500);
        });

        function showSpinner() {
            document.getElementById('spinnerOverlay').style.display = 'block';
        }
        function hideSpinner() {
            document.getElementById('spinnerOverlay').style.display = 'none';
        }
        function disableAllButtons() {
            document.querySelectorAll('.no-print button, .no-print select, .no-print input').forEach(el => {
                el.disabled = true;
            });
        }
        function enableAllButtons() {
            document.querySelectorAll('.no-print button:not(.editBtn):not(.saveBtn), .no-print select, .no-print input').forEach(el => {
                el.disabled = false;
            });
            document.querySelectorAll('.editBtn, .saveBtn').forEach(el => {
                el.disabled = false;
            });
            checkAutoFillAvailability();
        }

        const autoFillWeekThemesBtn = document.getElementById('autoFillWeekThemesBtn');
        autoFillWeekThemesBtn.addEventListener('click', async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showModal('API –∫–ª—é—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –∫–ª—é—á.', '–ü–æ–º–∏–ª–∫–∞');
                return;
            }

            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;
            if (!yearSelect || !monthSelect) {
                showModal('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫ —Ç–∞ –º—ñ—Å—è—Ü—å!', '–£–≤–∞–≥–∞');
                return;
            }

            disableAllButtons();
            showSpinner();

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const monthName = monthNamesUkr[monthIndex] || "";
            const pages = document.querySelectorAll('.page');
            const howManyWeeks = pages.length;
            if (howManyWeeks === 0) {
                showModal("–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å —Ç–∏–∂–Ω—ñ!");
                hideSpinner();
                enableAllButtons();
                return;
            }

            const promptText = `
–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π ${howManyWeeks} –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö —Ç–µ–º –¥–ª—è —Ç–∏–∂–Ω—ñ–≤ —É –¥–∏—Ç—è—á–æ–º—É —Å–∞–¥–æ—á–∫—É –≤ –£–∫—Ä–∞—ó–Ω—ñ 
–Ω–∞ –ø–µ—Ä—ñ–æ–¥: ${monthName} ${year}. 
–ö–æ–∂–Ω—É —Ç–µ–º—É –ø–æ–¥–∞–π –∑ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞. 
–¢–µ–º–∏ –º–∞—é—Ç—å –±—É—Ç–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–∏–º–∏, –∞–ª–µ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ —Å–µ–∑–æ–Ω —Ç–∞ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –≤–∏—Ö–æ–≤–∞–Ω–Ω—è –¥—ñ—Ç–µ–π –¥–æ—à–∫—ñ–ª—å–Ω–æ–≥–æ –≤—ñ–∫—É.
–Ø–∫—â–æ –≤ —Ç–∏–∂–Ω—ñ —î –¥–µ—Ä–∂–∞–≤–Ω–µ —Å–≤—è—Ç–æ –£–∫—Ä–∞—ó–Ω–∏ —á–∏ –≤–µ–ª–∏–∫–µ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–µ —Å–≤—è—Ç–æ, –±—É–¥—å –ª–∞—Å–∫–∞, –≤—Ä–∞—Ö—É–π –π–æ–≥–æ –ø—Ä–∏ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—ñ —Ç–µ–º–∏ —Ç–∏–∂–Ω—è, –∞–ª–µ –Ω–µ –∑–∞–∑–Ω–∞—á–∞–π —Ñ–∞–∫—Ç –≤—Ä–∞—Ö—É–≤–∞–Ω–Ω—è —É –Ω–∞–∑–≤—ñ.
–°–≤—è—Ç–∞ –ø–æ–≤–∏–Ω–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –ì—Ä–∏–≥–æ—Ä—ñ–∞–Ω—Å—å–∫–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é (–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 25 –≥—Ä—É–¥–Ω—è - –†—ñ–∑–¥–≤–æ –•—Ä–∏—Å—Ç–æ–≤–µ, –∞ –Ω–µ 7 —Å—ñ—á–Ω—è - –†—ñ–∑–¥–≤–æ –•—Ä–∏—Å—Ç–æ–≤–µ, —è–∫ —É –Æ–ª—ñ–∞–Ω—Å—å–∫–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ,
–∞–±–æ –¥–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –ú–∏–∫–æ–ª–∞—è –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ 6 –≥—Ä—É–¥–Ω—è, –∞ –Ω–µ 19 –≥—Ä—É–¥–Ω—è).
–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ç–∞–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤ —è–∫ –î—ñ–¥ –ú–æ—Ä–æ–∑, –°–Ω—ñ–≥—É—Ä–æ–Ω—å–∫–∞, –∑–∞–º—ñ—Å—Ç—å –Ω–∏—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –°–≤—è—Ç–æ–≥–æ –ú–∏–∫–æ–ª–∞—è.
–ù–∞–¥–∞–π –ª–∏—à–µ —Å–ø–∏—Å–æ–∫ —Ç–µ–º, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü—ñ—ó, –±–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤.
            `.trim();

            try {
                const selectedModel = getSelectedModel('weekThemes');
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: promptText }]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ API: ${response.status}`);
                }
                const data = await response.json();
                let generatedText = data.candidates[0].content.parts.at(-1).text || "";

                const lines = generatedText
                    .split(/\r?\n/)
                    .map(l => l.replace(/^\d+\)\s*/, '').trim())
                    .filter(Boolean);

                const weekInputs = document.querySelectorAll('.week-theme-input');
                for (let i = 0; i < weekInputs.length; i++) {
                    if (i < lines.length) {
                        weekInputs[i].value = lines[i];
                    }
                }

                saveGeneratedPages();
                showModal("–ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–µ–º —Ç–∏–∂–Ω—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!");
            } catch (error) {
                console.error(error);
                showModal("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –≤—ñ–¥ Gemini API: " + error.message);
            } finally {
                hideSpinner();
                enableAllButtons();
                updateRegenerateButtonsState();
            }
        });

        const autoFillDayThemesBtn = document.getElementById('autoFillDayThemesBtn');
        autoFillDayThemesBtn.addEventListener('click', async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showModal('API –∫–ª—é—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –∫–ª—é—á.');
                return;
            }

            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;
            if (!yearSelect || !monthSelect) {
                showModal('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫ —Ç–∞ –º—ñ—Å—è—Ü—å!');
                return;
            }

            disableAllButtons();
            showSpinner();

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const monthName = monthNamesUkr[monthIndex] || "";

            try {
                const allDayData = [];
                const pages = document.querySelectorAll('.page');
                for (let page of pages) {
                    const table = page.querySelector('table');
                    if (!table) continue;
                    const rows = table.querySelectorAll('tr');
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const dayCell = row.querySelector('td');
                        const strong = dayCell?.querySelector('strong');
                        const dayInput = row.querySelector('.day-theme-input');
                        if (!strong || !dayInput) continue;
                        const dateAndDayText = strong.textContent.trim();
                        allDayData.push({
                            dateAndDay: dateAndDayText,
                            dayInput: dayInput
                        });
                    }
                }
                if (allDayData.length === 0) {
                    showModal("–ù–µ–º–∞—î —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤ –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è!");
                    hideSpinner();
                    enableAllButtons();
                    return;
                }

                const howManyDays = allDayData.length;
                const datesList = allDayData.map(item => item.dateAndDay);

                const promptText = `
–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π ${howManyDays} —Ä—ñ–∑–Ω–∏—Ö, –∞–∫—Ç—É–∞–ª—å–Ω–∏—Ö —Ç–µ–º –¥–Ω—ñ–≤ –¥–ª—è –¥–∏—Ç—è—á–æ–≥–æ —Å–∞–¥–æ—á–∫–∞ 
–≤—Ä–∞—Ö–æ–≤—É—é—á–∏ —É—Å—ñ —Ü—ñ –¥–∞—Ç–∏ (–ø–µ—Ä—ñ–æ–¥: ${monthName} ${year}, —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é), 
–∑ –æ–≥–ª—è–¥—É –Ω–∞ —Ç–µ, —â–æ –≤ –£–∫—Ä–∞—ó–Ω—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ—Ñ—ñ—Ü—ñ–π–Ω—ñ –¥–µ—Ä–∂–∞–≤–Ω—ñ —Å–≤—è—Ç–∞ —Ç–∞ –≤–µ–ª–∏–∫—ñ —Å—É—á–∞—Å–Ω—ñ —Å–≤—è—Ç–∞ –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è —É –¥–µ—è–∫—ñ –∑ —Ü–∏—Ö –¥–∞—Ç. 
–°–≤—è—Ç–∞ –ø–æ–≤–∏–Ω–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –ì—Ä–∏–≥–æ—Ä—ñ–∞–Ω—Å—å–∫–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é (–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 25 –≥—Ä—É–¥–Ω—è - –†—ñ–∑–¥–≤–æ –•—Ä–∏—Å—Ç–æ–≤–µ, –∞ –Ω–µ 7 —Å—ñ—á–Ω—è - –†—ñ–∑–¥–≤–æ –•—Ä–∏—Å—Ç–æ–≤–µ, —è–∫ —É –Æ–ª—ñ–∞–Ω—Å—å–∫–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—ñ,
–∞–±–æ –¥–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –ú–∏–∫–æ–ª–∞—è –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ 6 –≥—Ä—É–¥–Ω—è, –∞ –Ω–µ 19 –≥—Ä—É–¥–Ω—è).
–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ç–∞–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤ —è–∫ –î—ñ–¥ –ú–æ—Ä–æ–∑, –°–Ω—ñ–≥—É—Ä–æ–Ω—å–∫–∞, –∑–∞–º—ñ—Å—Ç—å –Ω–∏—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –°–≤—è—Ç–æ–≥–æ –ú–∏–∫–æ–ª–∞—è.
–ö–æ–ª–∏ —Å–≤—è—Ç–æ –≤–∏–ø–∞–¥–∞—î –Ω–∞ –≤–∏—Ö—ñ–¥–Ω–∏–π, —Ç–æ–¥—ñ —Ç–µ–º–æ—é –Ω–∞–π–±–ª–∏–∂—á–æ–≥–æ —Ä–æ–±–æ—á–æ–≥–æ –¥–Ω—è –º–æ–∂–µ –±—É—Ç–∏ —Å–≤—è—Ç–æ.
–ü–æ–¥–∞–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É –≤–∏–≥–ª—è–¥—ñ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫—É —Ç–µ–º, –∫–æ–∂–Ω–∞ —Ç–µ–º–∞ –∑ –Ω–æ–≤–æ–≥–æ —Ä—è–¥–∫–∞.
–ù–µ –¥–æ–¥–∞–≤–∞–π –Ω—É–º–µ—Ä–∞—Ü—ñ—é —á–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –Ω–∞ –ø–æ—á–∞—Ç–∫—É —á–∏ –≤ –∫—ñ–Ω—Ü—ñ —Ç–µ–º–∏!
–û—Å—å –ø–µ—Ä–µ–ª—ñ–∫ –¥–∞—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É:
${datesList.join('\n')}`.trim();

                const selectedModel = getSelectedModel('dayThemes');
                const requestBody = {
                    contents: [{
                        parts: [{ text: promptText }]
                    }]
                };

                if (!selectedModel.includes('thinking-exp')) {
                    requestBody.generationConfig = {
                        temperature: 1,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 8192,
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "object",
                            properties: {
                                response: {
                                    type: "array",
                                    items: {
                                        type: "string"
                                    }
                                }
                            }
                        }
                    };
                }

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    }
                );

                if (!response.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ API: ${response.status}`);
                }
                const data = await response.json();
                let themes = [];

                try {
                    const responseText = data.candidates[0].content.parts[0].text;
                    const parsedResponse = JSON.parse(responseText);
                    themes = parsedResponse.response;
                } catch (e) {
                    const generatedText = data.candidates[0].content.parts.at(-1).text || "";
                    themes = generatedText
                        .split(/\r?\n/)
                        .map(line => line.replace(/^\d+[\.\)]\s*/, '').trim())
                        .filter(Boolean);
                }

                for (let i = 0; i < allDayData.length; i++) {
                    if (i < themes.length) {
                        allDayData[i].dayInput.value = themes[i];
                    }
                }

                saveGeneratedPages();
                showModal("–ê–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–µ–º –¥–Ω—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!");
            } catch (error) {
                console.error(error);
                showModal("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –≤—ñ–¥ Gemini API: " + error.message);
            } finally {
                hideSpinner();
                enableAllButtons();
                updateRegenerateButtonsState();
            }
        });

        const autoFillBtn = document.getElementById('autoFillBtn');
        autoFillBtn.addEventListener('click', async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showModal('API –∫–ª—é—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –°–ø–æ—á–∞—Ç–∫—É –∑–±–µ—Ä–µ–∂—ñ—Ç—å –∫–ª—é—á.');
                return;
            }

            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;
            if (!yearSelect || !monthSelect) {
                showModal('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫ —Ç–∞ –º—ñ—Å—è—Ü—å!');
                return;
            }

            disableAllButtons();
            showSpinner();

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const monthName = monthNamesUkr[monthIndex] || "";

            try {
                const pages = document.querySelectorAll('.page');
                for (let page of pages) {
                    const weekThemeInput = page.querySelector('.week-theme-input');
                    if (!weekThemeInput) continue;
                    const weekTheme = weekThemeInput.value.trim();
                    if (!weekTheme) continue;

                    const table = page.querySelector('table');
                    if (!table) continue;
                    const rows = table.querySelectorAll('tr');
                    const dayData = [];
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const dayThemeInput = row.querySelector('.day-theme-input');
                        if (!dayThemeInput) continue;
                        const dayCell = row.querySelector('td');
                        const strong = dayCell.querySelector('strong');
                        let dayText = strong ? strong.textContent : '';
                        dayData.push({
                            dateAndDay: dayText.trim(),
                            dayTheme: dayThemeInput.value.trim()
                        });
                    }

                    const promptObj = {
                        weekTheme: weekTheme,
                        days: dayData
                    };

                    const promptText = `
–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–≥–µ–Ω–µ—Ä—É–π –ø–ª–∞–Ω –∑–∞–Ω—è—Ç—å –¥–ª—è –¥–∏—Ç—è—á–æ–≥–æ —Å–∞–¥–æ—á–∫–∞ –≤ –£–∫—Ä–∞—ó–Ω—ñ –Ω–∞ —Ç–∏–∂–¥–µ–Ω—å (–ø–µ—Ä—ñ–æ–¥: ${monthName} ${year}) 
–∑–∞ —Ç–µ–º–æ—é "${promptObj.weekTheme}". 
–î–ª—è –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–æ 7 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –æ—Å–≤—ñ—Ç–Ω—ñ–º –ª—ñ–Ω—ñ—è–º:
1. ¬´–û—Å–æ–±–∏—Å—Ç—ñ—Å—Ç—å –¥–∏—Ç–∏–Ω–∏¬ª
2. ¬´–î–∏—Ç–∏–Ω–∞ –≤ —Å–æ—Ü—ñ—É–º—ñ¬ª
3. ¬´–î–∏—Ç–∏–Ω–∞ –≤ –ø—Ä–∏—Ä–æ–¥–Ω–æ–º—É –¥–æ–≤–∫—ñ–ª–ª—ñ¬ª
4. ¬´–î–∏—Ç–∏–Ω–∞ —É —Å–≤—ñ—Ç—ñ –∫—É–ª—å—Ç—É—Ä–∏¬ª
5. ¬´–ú–æ–≤–ª–µ–Ω–Ω—è –¥–∏—Ç–∏–Ω–∏¬ª
6. ¬´–î–∏—Ç–∏–Ω–∞ –≤ —Å–µ–Ω—Å–æ—Ä–Ω–æ-–º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ–º—É –ø—Ä–æ—Å—Ç–æ—Ä—ñ¬ª
7. ¬´–ì—Ä–∞ –¥–∏—Ç–∏–Ω–∏¬ª

–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –º–∞—é—Ç—å –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏:
- –ü–æ—Ä—É —Ä–æ–∫—É —Ç–∞ –¥–µ—Ä–∂–∞–≤–Ω—ñ —Å–≤—è—Ç–∞ –£–∫—Ä–∞—ó–Ω–∏
- –í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å –ì—Ä–∏–≥–æ—Ä—ñ–∞–Ω—Å—å–∫–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é (25 –≥—Ä—É–¥–Ω—è - –†—ñ–∑–¥–≤–æ –•—Ä–∏—Å—Ç–æ–≤–µ, 6 –≥—Ä—É–¥–Ω—è - –¥–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –ú–∏–∫–æ–ª–∞—è)
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –°–≤—è—Ç–æ–≥–æ –ú–∏–∫–æ–ª–∞—è –∑–∞–º—ñ—Å—Ç—å –î—ñ–¥–∞ –ú–æ—Ä–æ–∑–∞ —á–∏ –°–Ω—ñ–≥—É—Ä–æ–Ω—å–∫–∏
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏, –Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏—Å—è
- –í–∫–ª—é—á–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —ñ–≥—Ä–∏, —Ä—É—Ö–∞–Ω–∫–∏, —Ç–∞–Ω—Ü—ñ —Ç–∞ —ñ–Ω—à—ñ –≤–∏–¥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –¥–ª—è –¥–æ—à–∫—ñ–ª—å–Ω—è—Ç
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ —Ç–µ–º—ñ —Ç–∏–∂–Ω—è —Ç–∞ —Ç–µ–º—ñ –¥–Ω—è
- –£ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ –Ω–∞–∑–≤–æ—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ —è–≤–Ω–æ –ø—Ä–æ–ø–∏—Å—É–≤–∞—Ç–∏ –Ω–∞–∑–≤—É –æ—Å–≤—ñ—Ç–Ω—å–æ—ó –ª—ñ–Ω—ñ—ó

–û—Å—å –ø–µ—Ä–µ–ª—ñ–∫ –¥–Ω—ñ–≤ —Ç–∏–∂–Ω—è —ñ —Ç–µ–º–∏ –¥–Ω—ñ–≤ –¥–ª—è –ø–ª–∞–Ω—É:
${JSON.stringify(promptObj.days, null, 2)}`.trim();

                    const selectedModel = getSelectedModel('activities');
                    const requestBody = {
                        contents: [{
                            parts: [{ text: promptText }]
                        }]
                    };

                    if (!selectedModel.includes('thinking-exp')) {
                        requestBody.generationConfig = {
                            temperature: 1,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "object",
                                properties: {
                                    tableData: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                dateAndDay: { type: "string" },
                                                dayTheme: { type: "string" },
                                                lines: {
                                                    type: "array",
                                                    items: { type: "string" },
                                                    minItems: 7,
                                                    maxItems: 7
                                                }
                                            },
                                            required: ["dateAndDay", "dayTheme", "lines"]
                                        }
                                    }
                                },
                                required: ["tableData"]
                            }
                        };
                    }

                    function validateAndFillData(data) {
                        let allFilled = true;
                        if (!data || !data.tableData) return false;

                        const rows = table.querySelectorAll('tr');
                        for (let i = 1; i < rows.length; i++) {
                            const row = rows[i];
                            const dayCell = row.querySelector('td');
                            if (!dayCell) continue;

                            const strong = dayCell.querySelector('strong');
                            if (!strong) continue;

                            const currentDateAndDay = strong.textContent.trim();
                            const dayEntry = data.tableData.find(entry =>
                                entry.dateAndDay && entry.dateAndDay.includes(currentDateAndDay)
                            );

                            if (dayEntry && Array.isArray(dayEntry.lines)) {
                                const columns = row.querySelectorAll('td');
                                for (let colIndex = 1; colIndex < columns.length && colIndex <= 7; colIndex++) {
                                    if (dayEntry.lines[colIndex - 1]) {
                                        const td = columns[colIndex];
                                        let contentWrapper = td.querySelector('.flex');
                                        if (!contentWrapper) {
                                            contentWrapper = document.createElement('div');
                                            contentWrapper.className = 'flex justify-between items-start';
                                            const span = document.createElement('span');
                                            span.className = 'flex-grow';
                                            const button = td.querySelector('.regenerate-btn') ||
                                                document.createElement('button');
                                            button.className = 'regenerate-btn flex-shrink-0';
                                            button.setAttribute('data-type', 'activity');
                                            button.setAttribute('data-line', colIndex.toString());
                                            button.setAttribute('title', '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –Ω–æ–≤—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å');
                                            button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>`;
                                            contentWrapper.appendChild(span);
                                            contentWrapper.appendChild(button);
                                            td.innerHTML = '';
                                            td.appendChild(contentWrapper);
                                        }
                                        const span = contentWrapper.querySelector('span');
                                        if (span) {
                                            span.textContent = dayEntry.lines[colIndex - 1];
                                        } else {
                                            allFilled = false;
                                        }
                                    } else {
                                        allFilled = false;
                                    }
                                }
                            } else {
                                allFilled = false;
                            }
                        }
                        return allFilled;
                    }

                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestBody)
                            }
                        );

                        if (!response.ok) {
                            throw new Error(`–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ API: ${response.status}`);
                        }

                        const data = await response.json();
                        let parsedData = null;

                        try {
                            const responseText = data.candidates[0].content.parts[0].text;
                            parsedData = JSON.parse(responseText);
                        } catch (e) {
                            const generatedText = data.candidates[0].content.parts.at(-1).text || "";
                            try {
                                let jsonStr = generatedText.match(/\{[\s\S]*\}/);
                                if (jsonStr) {
                                    parsedData = JSON.parse(jsonStr[0]);
                                }
                            } catch (e2) {
                                const lines = generatedText
                                    .split(/\r?\n/)
                                    .map(line => line.replace(/^\d+[\.\)]\s*/, '').trim())
                                    .filter(Boolean);

                                parsedData = {
                                    tableData: promptObj.days.map((day, index) => ({
                                        dateAndDay: day.dateAndDay,
                                        dayTheme: day.dayTheme,
                                        lines: lines.slice(index * 7, (index + 1) * 7)
                                    }))
                                };
                            }
                        }

                        let fillSuccess = validateAndFillData(parsedData);

                        if (!fillSuccess) {
                            const retryResponse = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                }
                            );

                            if (retryResponse.ok) {
                                const retryData = await retryResponse.json();
                                try {
                                    const retryResponseText = retryData.candidates[0].content.parts[0].text;
                                    const retryParsedData = JSON.parse(retryResponseText);
                                    fillSuccess = validateAndFillData(retryParsedData);
                                } catch (e) {
                                    console.error("Retry attempt failed:", e);
                                }
                            }
                        }

                        if (!fillSuccess) {
                            console.warn("Could not fill all cells properly after retry");
                        }
                    } catch (error) {
                        console.error(error);
                        showModal("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –≤—ñ–¥ Gemini API: " + error.message);
                        continue;
                    }
                }

                saveGeneratedPages();
                showModal("–ü–æ–≤–Ω–µ –∞–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n" +
                    "–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—Å–µ —â–µ —Ä–∞–∑, –Ω–∞—Ç–∏—Å–Ω—É–≤—à–∏ —Ç—É –∂ –∫–Ω–æ–ø–∫—É, –∞–±–æ –∫–æ–∂–Ω—É –∫–æ–º—ñ—Ä–∫—É —Ç–∞–±–ª–∏—Ü—ñ –æ–∫—Ä–µ–º–æ, –∫–ª—ñ–∫–Ω—É–≤—à–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó.\n" +
                    "–ê–±–æ –∂ –≤–∏–±–µ—Ä—ñ—Ç—å —Ä—É—á–Ω–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–Ω–µ—Å—Ç–∏ –∑–º—ñ–Ω–∏ –∞–±–æ –æ–¥—Ä–∞–∑—É –¥—Ä—É–∫—É–π—Ç–µ.\n");
            } catch (error) {
                console.error(error);
                showModal("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –≤—ñ–¥ Gemini API: " + error.message);
            } finally {
                hideSpinner();
                enableAllButtons();
                updateRegenerateButtonsState();
            }
        });

        const printBtn = document.getElementById('btnPrint');
        printBtn.addEventListener('click', function () {
            const dayInputs = document.querySelectorAll('.day-theme-input');
            const weekInputs = document.querySelectorAll('.week-theme-input');

            const replacedElements = [];
            function replaceInputWithSpan(input) {
                const span = document.createElement('span');
                span.textContent = input.value.trim();
                replacedElements.push({ original: input, temp: span });
                input.parentNode.replaceChild(span, input);
            }

            dayInputs.forEach(input => replaceInputWithSpan(input));
            weekInputs.forEach(input => replaceInputWithSpan(input));

            window.print();

            replacedElements.forEach(({ original, temp }) => {
                temp.parentNode.replaceChild(original, temp);
            });
        });

        const btnInstructions = document.getElementById('btnInstructions');
        btnInstructions.addEventListener('click', function () {
            window.open('instructions.html', '_blank');
        });

        const btnLogout = document.getElementById('btnLogout');
        btnLogout.addEventListener('click', function () {
            if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏?')) {
                clearAuthData();
                window.location.href = 'index.html';
            }
        });
    </script>

    <!-- Modal Component -->
    <div id="customModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full transform transition-all">
            <div class="border-b px-6 py-4">
                <h3 id="modalTitle" class="text-lg font-medium text-gray-900"></h3>
            </div>
            <div class="px-6 py-4">
                <p id="modalMessage" class="text-gray-600"></p>
            </div>
            <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-end space-x-3">
                <button id="modalOkBtn"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        const modal = {
            element: document.getElementById('customModal'),
            titleElement: document.getElementById('modalTitle'),
            messageElement: document.getElementById('modalMessage'),
            okButton: document.getElementById('modalOkBtn'),

            show(title, message) {
                this.titleElement.textContent = title;
                this.messageElement.textContent = message;
                this.element.classList.remove('hidden');

                return new Promise((resolve) => {
                    const handleClick = () => {
                        this.hide();
                        this.okButton.removeEventListener('click', handleClick);
                        resolve(true);
                    };
                    this.okButton.addEventListener('click', handleClick);
                });
            },

            hide() {
                this.element.classList.add('hidden');
            }
        };

        async function showModal(message, title = '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è') {
            return modal.show(title, message);
        }
    </script>

    <!-- Installation button (hidden by default) -->
    <div id="installContainer" class="no-print hidden fixed bottom-4 right-4 z-50">
        <button id="installButton"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-lg flex items-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 01.707-.293.999.999 0 01.707.293l3 3a1 1 0 01-1.414 1.414l-3-3z"
                    clip-rule="evenodd" />
            </svg>
            <span>–Ü–Ω—Å—Ç–∞–ª—é–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫</span>
        </button>
    </div>

    <!-- Installation instructions modal -->
    <div id="installModal"
        class="no-print hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">–Ø–∫ —ñ–Ω—Å—Ç–∞–ª—é–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        –©–æ–± —ñ–Ω—Å—Ç–∞–ª—é–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫, –≤–∏–∫–æ–Ω–∞–π—Ç–µ —Ç–∞–∫—ñ –∫—Ä–æ–∫–∏:
                    </p>
                    <ul class="text-left text-sm text-gray-500 mt-2 space-y-2">
                        <li>1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–Ü–Ω—Å—Ç–∞–ª—é–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫"</li>
                        <li>2. –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å —ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—é —É –¥—ñ–∞–ª–æ–≥–æ–≤–æ–º—É –≤—ñ–∫–Ω—ñ</li>
                        <li>3. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —ñ–Ω—Å—Ç–∞–ª—è—Ü—ñ—ó</li>
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeInstallModal"
                        class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        –ó—Ä–æ–∑—É–º—ñ–ª–æ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Installation success notification -->
    <div id="installSuccess"
        class="hidden fixed bottom-4 left-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 z-50"
        role="alert">
        <p class="font-bold">–£—Å–ø—ñ—à–Ω–æ!</p>
        <p>–î–æ–¥–∞—Ç–æ–∫ –±—É–ª–æ —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—Å—Ç–∞–ª—å–æ–≤–∞–Ω–æ.</p>
    </div>

    <script>
        let deferredPrompt;
        const installContainer = document.getElementById('installContainer');
        const installButton = document.getElementById('installButton');
        const installModal = document.getElementById('installModal');
        const closeInstallModal = document.getElementById('closeInstallModal');
        const installSuccess = document.getElementById('installSuccess');

        function isPWAInstalled() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true;
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            if (!isPWAInstalled()) {
                installContainer.classList.remove('hidden');
            }
        });

        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) {
                installModal.classList.remove('hidden');
                return;
            }

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                showInstallSuccess();
            }
            deferredPrompt = null;
            installContainer.classList.add('hidden');
        });

        closeInstallModal.addEventListener('click', () => {
            installModal.classList.add('hidden');
        });

        installModal.addEventListener('click', (e) => {
            if (e.target === installModal) {
                installModal.classList.add('hidden');
            }
        });

        function showInstallSuccess() {
            installSuccess.classList.remove('hidden');
            setTimeout(() => {
                installSuccess.classList.add('hidden');
            }, 3000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (isPWAInstalled()) {
                installContainer.classList.add('hidden');
            }
        });

        window.addEventListener('appinstalled', (evt) => {
            installContainer.classList.add('hidden');
            showInstallSuccess();
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/weekly-education-plan-auto/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    <script>
        function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.update();
                });
            }
        }

        setInterval(checkForUpdates, 60 * 60 * 1000);

        if ('serviceWorker' in navigator) {
            let refreshing = false;

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    const updateNotification = document.createElement('div');
                    updateNotification.className = 'fixed bottom-4 left-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 z-50';
                    updateNotification.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-bold">–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–µ!</p>
                                <p>–ù–æ–≤–∞ –≤–µ—Ä—Å—ñ—è –¥–æ–¥–∞—Ç–∫—É –≥–æ—Ç–æ–≤–∞.</p>
                            </div>
                            <button onclick="window.location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded ml-4 hover:bg-blue-600">
                                –û–Ω–æ–≤–∏—Ç–∏
                            </button>
                        </div>
                    `;
                    document.body.appendChild(updateNotification);
                }
            });
        }
    </script>

    // Add this before the closing
</body> tag
<script>
    // Function to clear data while preserving essential items
    function clearDataOnUpdate() {
        const authData = localStorage.getItem('authData');
        const apiKey = localStorage.getItem('geminiApiKey');

        localStorage.clear();

        // Restore essential data
        if (apiKey) {
            localStorage.setItem('geminiApiKey', apiKey);
        }
        if (authData) {
            localStorage.setItem('authData', authData);
        }
    }

    // Check for service worker updates
    function checkForUpdates() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.update();
            });
        }
    }

    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data.type === 'CACHE_UPDATED') {
            // Show update notification
            const updateNotification = document.createElement('div');
            updateNotification.className = 'fixed bottom-4 left-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 z-50';
            updateNotification.innerHTML = `
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-bold">–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–µ!</p>
                    <p>–ù–æ–≤–∞ –≤–µ—Ä—Å—ñ—è –¥–æ–¥–∞—Ç–∫—É –≥–æ—Ç–æ–≤–∞.</p>
                </div>
                <button id="updateAndReloadBtn" class="bg-blue-500 text-white px-4 py-2 rounded ml-4 hover:bg-blue-600">
                    –û–Ω–æ–≤–∏—Ç–∏
                </button>
            </div>
        `;
            document.body.appendChild(updateNotification);

            // Handle update button click
            document.getElementById('updateAndReloadBtn').addEventListener('click', () => {
                clearDataOnUpdate();
                window.location.reload();
            });
        }
    });

    // Check for updates every hour
    setInterval(checkForUpdates, 60 * 60 * 1000);

    // Handle service worker controller change
    if ('serviceWorker' in navigator) {
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
                refreshing = true;
                clearDataOnUpdate();
                window.location.reload();
            }
        });
    }
</script>
</body>

</html>
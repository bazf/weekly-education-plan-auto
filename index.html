<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Планування занять (група "Казка")</title>
    <style>
        /* Базові стилі таблиць */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 40px;
        }
        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f2f2f2;
        }

        /* Кожна таблиця (і заголовок) обгорнуті в .page, щоб контролювати розриви */
        .page {
            page-break-after: always;
            break-inside: avoid;
        }

        /* Кнопки та їх стилі */
        .no-print {
            margin: 10px 0;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        input {
            padding: 5px;
            font-size: 14px;
        }

        /* При друку приховуємо панелі керування (клас .no-print) */
        @media print {
            .no-print {
                display: none !important;
            }
        }

        /*
           Примусово робимо сторінку A4 альбомною при друку.
           Зменшуємо масштаб (transform: scale(0.85)) щоб таблиця краще вміщувалась.
        */
        @page {
            size: A4 landscape;
            margin: 0mm;
        }
        @media print {
            body {
                transform: scale(0.85);
                transform-origin: top left;
            }
            table, th, td {
                font-size: 12px; /* За потреби змінюйте */
            }
            .page {
                page-break-inside: avoid !important;
            }
        }
    </style>
</head>
<body>

<!-- Блок налаштувань: вибір місяця, API ключа та автозаповнення -->
<div class="no-print">
    <h3>Налаштування місяця, API-ключа та автозаповнення</h3>

    <!-- Вибір року-місяця -->
    <label for="monthYearInput">Оберіть рік та місяць:</label>
    <input type="month" id="monthYearInput">
    <button id="generateWeeksBtn">Згенерувати таблиці</button>
    <br><br>

    <!-- Поле для введення API-ключа -->
    <label for="apiKeyInput">Google Gemini API Key:</label>
    <input type="text" id="apiKeyInput" placeholder="Введіть ваш ключ...">
    <button id="saveApiKeyBtn">Зберегти ключ</button>
    <br><br>

    <!-- Кнопки автозаповнення (дві окремі) -->
    <button id="autoFillBtn" disabled>Автозаповнення (приклад)</button>
    <button id="autoFillDayThemesBtn" disabled>Автозаповнення тем днів</button>
    <br><br>

    <!-- Кнопка друку -->
    <button id="btnPrint">Друк</button>
</div>

<script>
    /****************************************************
     * ВІДНОВЛЕННЯ ДАНИХ З LOCALSTORAGE (якщо були збережені)
     ****************************************************/
    document.addEventListener('DOMContentLoaded', function() {
        // Відновлюємо збережений ключ, якщо є
        const savedApiKey = localStorage.getItem('geminiApiKey');
        if (savedApiKey) {
            document.getElementById('apiKeyInput').value = savedApiKey;
        }

        // Відновлюємо збережений HTML (усіх .page разом)
        const savedPages = localStorage.getItem('allGeneratedPages');
        if (savedPages) {
            // Вставимо відновлений HTML у body
            document.body.insertAdjacentHTML('beforeend', savedPages);

            // Після вставляння – знову навішаємо обробники на кнопки редагування/збереження
            reattachTableHandlers();
            reattachThemeInputHandlers();
        }

        // Перевіряємо, чи можна активувати кнопки автозаповнення
        checkAutoFillAvailability();
    });

    /****************************************************
     * ЗБЕРІГАННЯ / ВІДНОВЛЕННЯ КОНТЕНТУ
     ****************************************************/
    function saveGeneratedPages() {
        // Зчитуємо всі .page і зберігаємо їхній зовнішній HTML у localStorage
        const pagesHtml = Array.from(document.querySelectorAll('.page'))
            .map(page => page.outerHTML)
            .join('\n');

        localStorage.setItem('allGeneratedPages', pagesHtml);
    }

    /****************************************************
     * ФУНКЦІЯ РЕДАГУВАННЯ ТАБЛИЦЬ (вмикаємо contentEditable)
     ****************************************************/
    function editTableContent(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        table.querySelectorAll('td, th').forEach(cell => {
            cell.contentEditable = 'true';
        });
    }

    /****************************************************
     * ФУНКЦІЯ ЗБЕРЕЖЕННЯ ТАБЛИЦЬ (вимикаємо contentEditable)
     ****************************************************/
    function saveTableContent(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        table.querySelectorAll('td, th').forEach(cell => {
            cell.contentEditable = 'false';
        });

        // Після вимкнення редагування – зберігаємо все у localStorage
        saveGeneratedPages();
        alert('Дані збережено успішно!');
    }

    /****************************************************
     * ОБРОБНИКИ КНОПОК "Редагувати" / "Зберегти"
     ****************************************************/
    function reattachTableHandlers() {
        document.querySelectorAll('.editBtn').forEach(btn => {
            btn.onclick = function() {
                const tableId = this.getAttribute('data-table');
                editTableContent(tableId);
            };
        });
        document.querySelectorAll('.saveBtn').forEach(btn => {
            btn.onclick = function() {
                const tableId = this.getAttribute('data-table');
                saveTableContent(tableId);
            };
        });
    }

    /****************************************************
     * ГЕНЕРАЦІЯ "РОБОЧИХ ТИЖНІВ" МІСЯЦЯ
     ****************************************************/
    const generateWeeksBtn = document.getElementById('generateWeeksBtn');
    generateWeeksBtn.addEventListener('click', () => {
        const monthInput = document.getElementById('monthYearInput').value;
        if (!monthInput) {
            alert('Будь ласка, виберіть рік та місяць!');
            return;
        }
        // Видаляємо усі поточні сторінки .page
        document.querySelectorAll('.page').forEach(page => page.remove());
        // Також очистимо збережені сторінки у localStorage
        localStorage.removeItem('allGeneratedPages');

        // Парсимо обраний рік і місяць
        const [year, monthStr] = monthInput.split('-');
        const month = parseInt(monthStr, 10) - 1; // JS-місяці з 0

        // Отримаємо "тижні" (масив масивів), де кожен тиждень складається тільки з робочих днів (пн–пт).
        const weeks = getWorkingWeeksOfMonth(year, month);
        if(weeks.length === 0) {
            alert('У цьому місяці немає робочих днів (за логікою getWorkingWeeksOfMonth).');
            return;
        }

        // Генеруємо блоки-«тижні»
        weeks.forEach((daysArray, index) => {
            const weekNumber = index + 1;

            // Перша й остання дата у тижні
            const firstDateStr = formatDateDDMM(daysArray[0]);
            const lastDateStr = formatDateDDMM(daysArray[daysArray.length - 1]);

            // Створюємо контейнер (.page)
            const pageDiv = document.createElement('div');
            pageDiv.classList.add('page');

            // Заголовок: "Тиждень X (DD.MM – DD.MM), Тема тижня: <input>"
            const h2 = document.createElement('h2');
            h2.innerHTML = `
                Тиждень ${weekNumber} (${firstDateStr} – ${lastDateStr}).
                <label> Тема тижня: <input type="text" class="week-theme-input" placeholder="Вкажіть тему тижня"> </label>
            `;
            pageDiv.appendChild(h2);

            // Кнопки редагування / збереження
            const noPrintDiv = document.createElement('div');
            noPrintDiv.classList.add('no-print');
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Редагувати';
            editBtn.classList.add('editBtn');
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Зберегти';
            saveBtn.classList.add('saveBtn');

            // Встановимо унікальний ID для таблиці
            const tableId = `weekTable${weekNumber}`;
            editBtn.setAttribute('data-table', tableId);
            saveBtn.setAttribute('data-table', tableId);

            noPrintDiv.appendChild(editBtn);
            noPrintDiv.appendChild(saveBtn);
            pageDiv.appendChild(noPrintDiv);

            // Створюємо таблицю
            const table = document.createElement('table');
            table.id = tableId;
            table.classList.add('editable-table');

            // Шапка
            table.innerHTML = `
                <tr>
                    <th>Дні тижня (Тема дня)</th>
                    <th>Освітня лінія «Особистість дитини»</th>
                    <th>Освітня лінія «Дитина в соціумі»</th>
                    <th>Освітня лінія «Дитина в природному довкіллі»</th>
                    <th>Освітня лінія «Дитина у світі культури»</th>
                    <th>Освітня лінія «Мовлення дитини»</th>
                    <th>Освітня лінія «Дитина в сенсорно-математичному просторі»</th>
                    <th>Освітня лінія «Гра дитини»</th>
                </tr>
            `;

            // Додаємо рядки для кожного робочого дня тижня
            daysArray.forEach(dayDate => {
                const ddMM = formatDateDDMM(dayDate);
                const dayOfWeekName = getDayNameUkr(dayDate.getDay());

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${ddMM} (${dayOfWeekName})</strong>
                        <br>
                        Тема дня: <input type="text" class="day-theme-input" placeholder="Вкажіть тему дня">
                    </td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                `;
                table.appendChild(row);
            });

            pageDiv.appendChild(table);
            document.body.appendChild(pageDiv);
        });

        // Заново навішуємо обробники на кнопки Редагувати/Зберегти
        reattachTableHandlers();

        // Навішуємо обробники на поля вводу (щоб відстежувати, коли всі теми заповнені)
        reattachThemeInputHandlers();

        // Зберігаємо порожні згенеровані таблиці в localStorage
        saveGeneratedPages();

        // Після генерації перевіряємо кнопки автозаповнення
        checkAutoFillAvailability();
    });

    /**
     * Повертає масив «тижнів» (кожен «тиждень» – це масив робочих днів),
     * де перший тиждень починається з першого робочого дня місяця (якщо це сер/чет/пт),
     * і кожен новий понеділок створює нову таблицю.
     * Суботи і неділі пропускаються.
     */
    function getWorkingWeeksOfMonth(year, month) {
        // Спочатку зберемо всі робочі дні (пн–пт) у масив "allWorkDays".
        const allWorkDays = [];
        let d = new Date(year, month, 1);

        while (d.getMonth() === month) {
            const dayOfWeek = d.getDay(); // 0=Нд, 1=Пн, ... 6=Сб
            if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                // Це робочий день (пн–пт)
                allWorkDays.push(new Date(d));
            }
            d.setDate(d.getDate() + 1);
        }

        if (allWorkDays.length === 0) return [];

        // Тепер поділимо "allWorkDays" на «тижні»:
        const weeks = [];
        let currentWeek = [];

        for (let i = 0; i < allWorkDays.length; i++) {
            const dayDate = allWorkDays[i];
            // Якщо це понеділок і "currentWeek" вже містить дні, починаємо новий тиждень
            if (dayDate.getDay() === 1 && currentWeek.length > 0) {
                weeks.push(currentWeek);
                currentWeek = [];
            }
            currentWeek.push(dayDate);
        }
        // Додаємо останній тиждень, якщо є
        if (currentWeek.length > 0) {
            weeks.push(currentWeek);
        }

        return weeks;
    }

    // Допоміжні форматери
    function formatDateDDMM(dateObj) {
        const dd = String(dateObj.getDate()).padStart(2, '0');
        const mm = String(dateObj.getMonth()+1).padStart(2, '0');
        return dd + '.' + mm;
    }
    function getDayNameUkr(dayIndex) {
        // dayIndex: 0(Нд), 1(Пн), 2(Вт), ...
        const days = [
            'Неділя',   // 0
            'Понеділок',// 1
            'Вівторок', // 2
            'Середа',   // 3
            'Четвер',   // 4
            'П’ятниця', // 5
            'Субота'    // 6
        ];
        return days[dayIndex] || '';
    }

    /****************************************************
     * ВВІД / КОНТРОЛЬ ТЕМ ТИЖНІВ ТА ДНІВ
     ****************************************************/
    function reattachThemeInputHandlers() {
        // Усі поля .week-theme-input і .day-theme-input
        const weekInputs = document.querySelectorAll('.week-theme-input');
        const dayInputs = document.querySelectorAll('.day-theme-input');

        // Слухаємо події input
        weekInputs.forEach(input => {
            input.addEventListener('input', checkAutoFillAvailability);
        });
        dayInputs.forEach(input => {
            input.addEventListener('input', checkAutoFillAvailability);
        });
    }

    // Перевірка: чи всі теми тижнів і днів заповнені
    function areAllThemesFilled() {
        const weekInputs = document.querySelectorAll('.week-theme-input');
        const dayInputs = document.querySelectorAll('.day-theme-input');
        for (let wi of weekInputs) {
            if (!wi.value.trim()) {
                return false;
            }
        }
        for (let di of dayInputs) {
            if (!di.value.trim()) {
                return false;
            }
        }
        return true;
    }

    // Перевірка для кнопок автозаповнення
    function checkAutoFillAvailability() {
        const autoFillBtn = document.getElementById('autoFillBtn');
        const autoFillDayThemesBtn = document.getElementById('autoFillDayThemesBtn');
        const apiKey = localStorage.getItem('geminiApiKey') || '';

        // Якщо ключа немає — кнопки вимкнені
        if (!apiKey.trim()) {
            autoFillBtn.disabled = true;
            autoFillDayThemesBtn.disabled = true;
            return;
        }

        // "autoFillBtn" (приклад) вмикаємо, якщо ключ є (не обов'язково всі теми заповнені)
        autoFillBtn.disabled = false;

        // "autoFillDayThemesBtn" вмикаємо, лише якщо ключ є і заповнені всі теми тижнів
        // (наприклад, щоб ґрунтуватися на "Темі тижня" під час генерації).
        let allWeekThemesFilled = true;
        document.querySelectorAll('.week-theme-input').forEach(wi => {
            if (!wi.value.trim()) allWeekThemesFilled = false;
        });
        autoFillDayThemesBtn.disabled = !allWeekThemesFilled;
    }

    /****************************************************
     * ЗБЕРЕЖЕННЯ API-КЛЮЧА В LOCALSTORAGE
     ****************************************************/
    const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
    saveApiKeyBtn.addEventListener('click', () => {
        const keyInput = document.getElementById('apiKeyInput').value.trim();
        if (keyInput) {
            localStorage.setItem('geminiApiKey', keyInput);
            alert('API ключ збережено успішно!');
        } else {
            alert('Введіть дійсний API ключ!');
        }
        checkAutoFillAvailability();
    });

    /****************************************************
     * ДРУК
     ****************************************************/
    document.getElementById('btnPrint').addEventListener('click', function() {
        window.print();
    });

    /****************************************************
     * АВТОЗАПОВНЕННЯ (ПРИКЛАД)
     ****************************************************/
    const autoFillBtn = document.getElementById('autoFillBtn');
    autoFillBtn.addEventListener('click', async () => {
        // Демонстраційний приклад автозаповнення (не обов’язково залежить від тем)
        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            alert('API ключ не знайдено! Спочатку збережіть ключ.');
            return;
        }
        try {
            const promptText = "Write a short plan for preschool children about winter games.";
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: promptText }]
                        }]
                    })
                }
            );
            if (!response.ok) {
                throw new Error(`Помилка від API: ${response.status}`);
            }
            const data = await response.json();
            let generatedText = "";
            if (data.contents && data.contents[0].parts && data.contents[0].parts[0].text) {
                generatedText = data.contents[0].parts[0].text;
            }
            alert("Отриманий текст:\n" + generatedText);
            // За потреби - розкласти у таблиці
        } catch (error) {
            console.error(error);
            alert("Не вдалося отримати дані від Gemini API: " + error.message);
        }
    });

    /****************************************************
     * АВТОЗАПОВНЕННЯ ТЕМ ДНІВ (НОВА КНОПКА)
     ****************************************************/
    const autoFillDayThemesBtn = document.getElementById('autoFillDayThemesBtn');
    autoFillDayThemesBtn.addEventListener('click', async () => {
        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            alert('API ключ не знайдено! Спочатку збережіть ключ.');
            return;
        }
        try {
            // Обходимо кожен "Тиждень" (.page).
            const pages = document.querySelectorAll('.page');
            for (let page of pages) {
                const weekThemeInput = page.querySelector('.week-theme-input');
                if (!weekThemeInput) continue;
                
                const weekTheme = weekThemeInput.value.trim();
                if (!weekTheme) continue; // якщо не заповнено — пропускаємо

                // Знайдемо всі інпути .day-theme-input (для 3–5 днів, залежно від тижня)
                const dayInputs = page.querySelectorAll('.day-theme-input');

                // Prompt: "Придумай 5 (чи менше) коротких тем для днів тижня..."
                // У прикладі беремо довжину dayInputs (наприклад, 3 чи 5).
                const howMany = dayInputs.length;

                const promptText = `Будь ласка, запропонуй ${howMany} коротких тем для днів тижня за загальною темою: "${weekTheme}". 
Вкажи кожну тему з нового рядка.`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: promptText }]
                            }]
                        })
                    }
                );
                if (!response.ok) {
                    throw new Error(`Помилка від API: ${response.status}`);
                }
                const data = await response.json();
                let generatedText = "";
                if (data.contents && data.contents[0].parts && data.contents[0].parts[0].text) {
                    generatedText = data.contents[0].parts[0].text;
                }
                // Спробуємо розділити результат на рядки
                const lines = generatedText
                    .split('\n')
                    .map(l => l.trim())
                    .filter(Boolean);

                // Заповнимо day-theme-input (тільки якщо вони ще порожні)
                for (let i = 0; i < dayInputs.length; i++) {
                    if (!dayInputs[i].value.trim()) {
                        if (i < lines.length) {
                            dayInputs[i].value = lines[i];
                        }
                    }
                }
            }
            // Зберігаємо зміни
            saveGeneratedPages();
            alert("Автозаповнення тем днів завершено!");
        } catch (error) {
            console.error(error);
            alert("Не вдалося отримати дані від Gemini API: " + error.message);
        }
    });
</script>

</body>
</html>

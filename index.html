<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Планування занять (група "Казка")</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Keep original print styles */
        @media print {
            .no-print {
                display: none !important;
            }

            @page {
                size: A4 landscape;
                margin: 0;
                /* Remove page margins completely */
            }

            body {
                margin: 0;
                padding: 0;
                width: 100vw;
            }

            .container {
                margin: 0;
                padding: 0;
                width: 100%;
            }

            .page {
                width: 100%;
                margin: 0;
                page-break-after: always;
                break-inside: avoid;
                page-break-inside: avoid !important;
                display: flex;
                flex-direction: column;
            }

            /* Title section */
            .page h2 {
                margin: 0 0 4mm 0;
                font-size: 11pt;
                flex: 0 0 auto;
            }

            /* Make table fill remaining space */
            table {
                width: 100% !important;
                table-layout: fixed;
                border-collapse: collapse;
                font-size: 8pt;
                margin: 0;
                flex: 1;
            }

            thead {
                height: 12%;
            }

            th,
            td {
                padding: 2mm !important;
                word-wrap: break-word;
                font-size: 8pt;
                line-height: 1.2;
                vertical-align: top;
            }

            /* Make date column smaller */
            table td:first-child,
            table th:first-child {
                width: 8%;
            }

            /* Distribute remaining width */
            table td:not(:first-child),
            table th:not(:first-child) {
                width: 13.14%;
            }

            /* Handle inputs and text */
            input,
            span {
                max-width: 100%;
                word-wrap: break-word;
                font-size: 8pt;
            }

            /* Theme inputs */
            .week-theme-input {
                margin: 2px 0;
                padding: 1px;
                font-size: 8pt;
            }

            .day-theme-input {
                margin: 1px 0;
                padding: 1px;
                font-size: 8pt;
            }
        }

        /* Spinner styles */
        #spinnerOverlay {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            padding-top: 20%;
            font-size: 24px;
        }

        .spinnerIcon {
            border: 6px solid #f3f3f3;
            border-radius: 50%;
            border-top: 6px solid #3498db;
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Hidden sections */
        #modelSelectContainer {
            display: none;
        }

        #aiAutofillSection {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Main container with responsive padding -->
    <div class="container mx-auto px-4 py-8">
        <!-- Control panel -->
        <div class="no-print space-y-6 mb-8">
            <!-- Action buttons -->
            <div class="flex flex-wrap gap-4">
                <button id="btnPrint" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    Друк
                </button>
                <div class="flex items-center gap-2">
                    <button id="btnClearAll" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                        Очистити Все
                    </button>
                    <label class="flex items-center">
                        <input type="checkbox" id="clearApiKeyCheck" class="h-5 w-5 text-red-600" disabled>
                        <span class="ml-2 text-gray-700">Видалити API ключ</span>
                    </label>
                </div>
                <button id="btnInstructions" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    Інструкція
                </button>
            </div>

            <!-- Settings section -->
            <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                <h3 class="text-xl font-semibold mb-4">Налаштування місяця, року та автозаповнення</h3>

                <!-- Year and month selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="yearSelect" class="block text-sm font-medium text-gray-700">
                            Оберіть рік:
                        </label>
                        <select id="yearSelect" class="w-full border rounded-md py-2 px-3">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label for="monthSelect" class="block text-sm font-medium text-gray-700">
                            Оберіть місяць:
                        </label>
                        <select id="monthSelect" class="w-full border rounded-md py-2 px-3">
                            <option value="1">Січень</option>
                            <option value="2">Лютий</option>
                            <option value="3">Березень</option>
                            <option value="4">Квітень</option>
                            <option value="5">Травень</option>
                            <option value="6">Червень</option>
                            <option value="7">Липень</option>
                            <option value="8">Серпень</option>
                            <option value="9">Вересень</option>
                            <option value="10">Жовтень</option>
                            <option value="11">Листопад</option>
                            <option value="12">Грудень</option>
                        </select>
                    </div>
                </div>

                <button id="generateWeeksBtn"
                    class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Створити порожні таблиці
                </button>
            </div>

            <!-- AI Settings section -->
            <div class="space-y-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="useAICheck" class="h-5 w-5 text-blue-600">
                    <span class="text-gray-700">Використовувати ШІ для автозаповнення</span>
                </label>

                <div id="aiAutofillSection" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <!-- API Key input -->
                    <div class="space-y-2">
                        <label for="apiKeyInput" class="block text-sm font-medium text-gray-700">
                            Google Gemini API Key:
                        </label>
                        <input type="text" id="apiKeyInput" class="w-full border rounded-md py-2 px-3"
                            placeholder="Введіть ваш ключ..." autocomplete="off">
                    </div>

                    <!-- Model selection -->
                    <div class="space-y-2">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="useModelsCheck" class="h-5 w-5 text-blue-600">
                            <span class="text-gray-700">Використати іншу модель ШІ</span>
                        </label>

                        <!-- Change this div's class -->
                        <div id="modelSelectContainer" style="display: none;">
                            <label for="modelSelect" class="block text-sm font-medium text-gray-700">
                                Оберіть модель (від найшвидшої до найрозумнішої):
                            </label>
                            <select id="modelSelect" class="w-full border rounded-md py-2 px-3">
                                <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                                <option value="gemini-2.0-flash-thinking-exp-1219">Gemini 2.0 Flash Thinking Exp 1219
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- Autofill buttons -->
                    <div class="flex flex-wrap gap-4">
                        <button id="autoFillWeekThemesBtn" disabled
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded disabled:opacity-50">
                            Автозаповнення тем тижнів
                        </button>
                        <button id="autoFillDayThemesBtn" disabled
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded disabled:opacity-50">
                            Автозаповнення тем днів
                        </button>
                        <button id="autoFillBtn" disabled
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded disabled:opacity-50">
                            Автозаповнення (повна таблиця)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table container with horizontal scroll on mobile -->
        <div class="overflow-x-auto">
            <!-- Tables will be generated here -->
        </div>
    </div>

    <!-- Spinner overlay -->
    <div id="spinnerOverlay">
        <div class="spinnerIcon"></div>
        <div>Заповнюю, очікуйте, будь ласка!</div>
    </div>

    <!-- JavaScript Section -->
    <script>
        /****************************************************
         * Змінна для назв місяців українською
         ****************************************************/
        const monthNamesUkr = [
            "Січень", "Лютий", "Березень", "Квітень", "Травень", "Червень",
            "Липень", "Серпень", "Вересень", "Жовтень", "Листопад", "Грудень"
        ];

        function setDefaultNextMonth() {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);

            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');

            // Set default year
            const nextYear = nextMonth.getFullYear().toString();
            if (yearSelect.querySelector(`option[value="${nextYear}"]`)) {
                yearSelect.value = nextYear;
            }

            // Set default month (1-12)
            const nextMonthNumber = (nextMonth.getMonth() + 1).toString();
            if (monthSelect.querySelector(`option[value="${nextMonthNumber}"]`)) {
                monthSelect.value = nextMonthNumber;
            }

            // Save to localStorage
            localStorage.setItem('selectedYear', nextYear);
            localStorage.setItem('selectedMonth', nextMonthNumber);
        }

        /****************************************************
         * ВІДНОВЛЕННЯ ДАНИХ З LOCALSTORAGE
         ****************************************************/
        document.addEventListener('DOMContentLoaded', function () {
            // Set default next month if no saved values exist
            if (!localStorage.getItem('selectedYear') || !localStorage.getItem('selectedMonth')) {
                setDefaultNextMonth();
            }

            // Відновлюємо збережений ключ, якщо є
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                document.getElementById('apiKeyInput').value = savedApiKey;
            }

            // Відновлюємо збережений рік і місяць, якщо є
            const savedSelectedYear = localStorage.getItem('selectedYear');
            const savedSelectedMonth = localStorage.getItem('selectedMonth');
            if (savedSelectedYear) {
                document.getElementById('yearSelect').value = savedSelectedYear;
            }
            if (savedSelectedMonth) {
                document.getElementById('monthSelect').value = savedSelectedMonth;
            }

            // НОВЕ! – Відновлюємо статус чекбокса "Використовувати ШІ для автозаповнення"
            const savedUseAICheck = localStorage.getItem('useAICheck');
            const useAICheck = document.getElementById('useAICheck');
            const aiAutofillSection = document.getElementById('aiAutofillSection');
            if (savedUseAICheck === 'true') {
                useAICheck.checked = true;
                aiAutofillSection.style.display = 'block';
            }

            // Відновлюємо вибрану модель (або ставимо за замовчуванням)
            const savedModel = localStorage.getItem('selectedModel');
            const useModelsCheck = document.getElementById('useModelsCheck');
            const modelSelectContainer = document.getElementById('modelSelectContainer');
            const modelSelect = document.getElementById('modelSelect');

            // Якщо користувач колись зберігав не "gemini-2.0-flash-exp", то вмикаємо чекбокс і селектор
            if (savedModel && savedModel !== "gemini-2.0-flash-exp") {
                useModelsCheck.checked = true;
                modelSelectContainer.style.display = "block";
                modelSelect.value = savedModel;
            } else {
                // Якщо нічого не було збережено — спробуємо вибрати за замовчуванням
                if (!savedModel) {
                    localStorage.setItem('selectedModel', 'gemini-2.0-flash-exp');
                }
                // Чекбокс вимкнутий, селектор прихований
                useModelsCheck.checked = false;
                modelSelectContainer.style.display = "none";
                modelSelect.value = 'gemini-2.0-flash-exp';
            }

            // Відновлюємо збережений HTML (усіх .page разом), якщо було
            const savedPages = localStorage.getItem('allGeneratedPages');
            if (savedPages) {
                document.querySelector('.overflow-x-auto').insertAdjacentHTML('beforeend', savedPages);
                reattachTableHandlers();
                reattachThemeInputHandlers();
            }

            // Перевіряємо, чи можна активувати кнопки автозаповнення
            checkAutoFillAvailability();

            // Add this to initialize the checkbox state
            updateClearApiKeyCheckbox();

            // Update useAICheck initial state
            const hasGeneratedTables = document.querySelectorAll('.page').length > 0;
            if (!hasGeneratedTables) {
                useAICheck.checked = false;
                aiAutofillSection.style.display = 'none';
            }

            updateGenerateButtonState();
        });

        /****************************************************
         * НОВЕ! – Логіка чекбокса "Використовувати ШІ для автозаповнення"
         ****************************************************/
        const useAICheck = document.getElementById('useAICheck');
        const aiAutofillSection = document.getElementById('aiAutofillSection');
        useAICheck.addEventListener('change', function () {
            const hasGeneratedTables = document.querySelectorAll('.page').length > 0;
            if (!hasGeneratedTables) {
                this.checked = false;
                alert('Спочатку створіть таблиці!');
                return;
            }

            aiAutofillSection.style.display = this.checked ? 'block' : 'none';
            localStorage.setItem('useAICheck', this.checked);
        });

        /****************************************************
         * ЛОГІКА ЧЕКБОКСА "ВИКОРИСТАТИ ІНШІ МОДЕЛІ"
         ****************************************************/
        const useModelsCheck = document.getElementById('useModelsCheck');
        const modelSelectContainer = document.getElementById('modelSelectContainer');
        const modelSelect = document.getElementById('modelSelect');

        useModelsCheck.addEventListener('change', function () {
            if (this.checked) {
                // Show the model selector container by setting display to block
                modelSelectContainer.style.display = 'block';
            } else {
                // Hide the selector container and reset to default model
                modelSelectContainer.style.display = 'none';
                modelSelect.value = 'gemini-2.0-flash-exp';
                localStorage.setItem('selectedModel', 'gemini-2.0-flash-exp');
            }
        });

        // Коли користувач змінює модель у селекторі
        modelSelect.addEventListener('change', function () {
            localStorage.setItem('selectedModel', this.value);
        });

        /**
         * Допоміжна функція, яка повертає поточну (обрану) модель або дефолтну.
         */
        function getSelectedModel() {
            const savedModel = localStorage.getItem('selectedModel') || 'gemini-2.0-flash-exp';
            return savedModel.trim();
        }

        /****************************************************
         * КНОПКА "ОЧИСТИТИ ВСЕ"
         ****************************************************/
        const clearApiKeyCheck = document.getElementById('clearApiKeyCheck');

        // Add function to update checkbox state based on API key presence
        function updateClearApiKeyCheckbox() {
            const apiKey = localStorage.getItem('geminiApiKey');
            clearApiKeyCheck.disabled = !apiKey;
            if (!apiKey) {
                clearApiKeyCheck.checked = false;
            }
        }

        btnClearAll.addEventListener('click', function () {
            if (confirm("Ви впевнені, що хочете видалити всі дані та перезавантажити сторінку?")) {
                if (!clearApiKeyCheck.checked) {
                    // Save the API key temporarily
                    const apiKey = localStorage.getItem('geminiApiKey');
                    localStorage.clear();
                    if (apiKey) {
                        localStorage.setItem('geminiApiKey', apiKey);
                    }
                } else {
                    localStorage.clear();
                }
                window.location.reload();
            }
        });

        /****************************************************
         * ЗБЕРІГАННЯ / ВІДНОВЛЕННЯ КОНТЕНТУ
         ****************************************************/
        function saveGeneratedPages() {
            // У кожного інпуту проставити value
            document.querySelectorAll('.page').forEach(page => {
                page.querySelectorAll('input').forEach(input => {
                    input.setAttribute('value', input.value);
                });
            });

            // Зчитуємо всі .page і зберігаємо їхній HTML
            const pagesHtml = Array.from(document.querySelectorAll('.page'))
                .map(page => page.outerHTML)
                .join('\n');
            localStorage.setItem('allGeneratedPages', pagesHtml);
        }

        /****************************************************
         * РЕДАГУВАННЯ / ЗБЕРЕЖЕННЯ ТАБЛИЦЬ (contentEditable)
         ****************************************************/
        function editTableContent(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            table.querySelectorAll('td, th').forEach(cell => {
                cell.contentEditable = 'true';
            });
        }

        function saveTableContent(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            table.querySelectorAll('td, th').forEach(cell => {
                cell.contentEditable = 'false';
            });

            saveGeneratedPages();
            alert('Дані збережено успішно!');
        }

        function reattachTableHandlers() {
            document.querySelectorAll('.editBtn').forEach(btn => {
                btn.disabled = false; // Ensure edit buttons are enabled
                btn.onclick = function () {
                    const tableId = this.getAttribute('data-table');
                    editTableContent(tableId);
                };
            });

            document.querySelectorAll('.saveBtn').forEach(btn => {
                btn.disabled = false; // Ensure save buttons are enabled
                btn.onclick = function () {
                    const tableId = this.getAttribute('data-table');
                    saveTableContent(tableId);
                };
            });
        }

        function updateGenerateButtonState() {
            const hasGeneratedTables = document.querySelectorAll('.page').length > 0;
            const generateWeeksBtn = document.getElementById('generateWeeksBtn');

            if (hasGeneratedTables) {
                generateWeeksBtn.textContent = 'Перестворити порожні таблиці';
                generateWeeksBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                generateWeeksBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
            } else {
                generateWeeksBtn.textContent = 'Створити порожні таблиці';
                generateWeeksBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                generateWeeksBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            }
        }

        /****************************************************
         * ГЕНЕРАЦІЯ "РОБОЧИХ ТИЖНІВ" МІСЯЦЯ
         ****************************************************/
        const generateWeeksBtn = document.getElementById('generateWeeksBtn');
        generateWeeksBtn.addEventListener('click', () => {
            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;

            if (!yearSelect || !monthSelect) {
                alert('Будь ласка, оберіть рік та місяць!');
                return;
            }

            localStorage.setItem('selectedYear', yearSelect);
            localStorage.setItem('selectedMonth', monthSelect);

            // Видаляємо всі сторінки .page з DOM та localStorage
            document.querySelectorAll('.page').forEach(page => page.remove());
            localStorage.removeItem('allGeneratedPages');

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const weeks = getWorkingWeeksOfMonth(year, monthIndex);
            if (weeks.length === 0) {
                alert('У цьому місяці немає робочих днів (за логікою getWorkingWeeksOfMonth).');
                return;
            }

            const tableContainer = document.querySelector('.overflow-x-auto');

            weeks.forEach((daysArray, index) => {
                const weekNumber = index + 1;
                const firstDateStr = formatDateDDMM(daysArray[0]);
                const lastDateStr = formatDateDDMM(daysArray[daysArray.length - 1]);

                const pageDiv = document.createElement('div');
                pageDiv.classList.add('page', 'mb-8');

                const header = document.createElement('h2');
                header.classList.add('text-lg', 'font-semibold', 'mb-4');
                header.innerHTML = `
                    Тиждень ${weekNumber} (${firstDateStr} – ${lastDateStr}).
                    <div class="mt-2">
                        <label class="inline-flex items-center">
                            Тема тижня: 
                            <input type="text" class="week-theme-input border rounded-md ml-2 py-1 px-2" placeholder="Вкажіть тему тижня">
                        </label>
                    </div>
                `;
                pageDiv.appendChild(header);

                const noPrintDiv = document.createElement('div');
                noPrintDiv.classList.add('no-print', 'flex', 'space-x-2', 'mb-4');
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Редагувати';
                editBtn.classList.add('editBtn', 'bg-yellow-500', 'hover:bg-yellow-600', 'text-white', 'px-4', 'py-2', 'rounded');
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Зберегти';
                saveBtn.classList.add('saveBtn', 'bg-green-500', 'hover:bg-green-600', 'text-white', 'px-4', 'py-2', 'rounded');

                const tableId = `weekTable${weekNumber}`;
                editBtn.setAttribute('data-table', tableId);
                saveBtn.setAttribute('data-table', tableId);

                noPrintDiv.appendChild(editBtn);
                noPrintDiv.appendChild(saveBtn);
                pageDiv.appendChild(noPrintDiv);

                const table = document.createElement('table');
                table.id = tableId;
                table.classList.add('min-w-full', 'bg-white', 'shadow-md', 'rounded', 'overflow-hidden');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="px-4 py-2">Дні тижня (Тема дня)</th>
                            <th class="px-4 py-2">Освітня лінія «Особистість дитини»</th>
                            <th class="px-4 py-2">Освітня лінія «Дитина в соціумі»</th>
                            <th class="px-4 py-2">Освітня лінія «Дитина в природному довкіллі»</th>
                            <th class="px-4 py-2">Освітня лінія «Дитина у світі культури»</th>
                            <th class="px-4 py-2">Освітня лінія «Мовлення дитини»</th>
                            <th class="px-4 py-2">Освітня лінія «Дитина в сенсорно-математичному просторі»</th>
                            <th class="px-4 py-2">Освітня лінія «Гра дитини»</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;

                daysArray.forEach(dayDate => {
                    const ddMM = formatDateDDMM(dayDate);
                    const dayOfWeekName = getDayNameUkr(dayDate.getDay());

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border px-4 py-2">
                            <strong>${ddMM} (${dayOfWeekName})</strong>
                            <br>
                            Тема дня: <input type="text" class="day-theme-input border rounded-md mt-1 py-1 px-2" placeholder="Вкажіть тему дня">
                        </td>
                        <td class="border px-4 py-2"></td>
                        <td class="border px-4 py-2"></td>
                        <td class="border px-4 py-2"></td>
                        <td class="border px-4 py-2"></td>
                        <td class="border px-4 py-2"></td>
                        <td class="border px-4 py-2"></td>
                        <td class="border px-4 py-2"></td>
                    `;
                    table.querySelector('tbody').appendChild(row);
                });

                pageDiv.appendChild(table);
                tableContainer.appendChild(pageDiv);
            });

            useAICheck.disabled = false;

            reattachTableHandlers();
            reattachThemeInputHandlers();
            saveGeneratedPages();
            checkAutoFillAvailability();
            updateGenerateButtonState();
        });

        function getWorkingWeeksOfMonth(year, month) {
            const allWorkDays = [];
            let d = new Date(year, month, 1);
            while (d.getMonth() === month) {
                const dayOfWeek = d.getDay(); // 0=Нд, 1=Пн, ... 6=Сб
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    allWorkDays.push(new Date(d));
                }
                d.setDate(d.getDate() + 1);
            }
            if (allWorkDays.length === 0) return [];

            const weeks = [];
            let currentWeek = [];
            for (let i = 0; i < allWorkDays.length; i++) {
                const dayDate = allWorkDays[i];
                // якщо наступний робочий день – це Понеділок, отже починається новий тиждень
                if (dayDate.getDay() === 1 && currentWeek.length > 0) {
                    weeks.push(currentWeek);
                    currentWeek = [];
                }
                currentWeek.push(dayDate);
            }
            if (currentWeek.length > 0) {
                weeks.push(currentWeek);
            }
            return weeks;
        }

        function formatDateDDMM(dateObj) {
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            return dd + '.' + mm;
        }

        function getDayNameUkr(dayIndex) {
            const days = [
                'Неділя',
                'Понеділок',
                'Вівторок',
                'Середа',
                'Четвер',
                'П’ятниця',
                'Субота'
            ];
            return days[dayIndex] || '';
        }

        /****************************************************
         * ВВІД / КОНТРОЛЬ ТЕМ ТИЖНІВ ТА ДНІВ
         ****************************************************/
        function reattachThemeInputHandlers() {
            const weekInputs = document.querySelectorAll('.week-theme-input');
            const dayInputs = document.querySelectorAll('.day-theme-input');

            weekInputs.forEach(input => {
                input.addEventListener('input', checkAutoFillAvailability);
            });
            dayInputs.forEach(input => {
                input.addEventListener('input', checkAutoFillAvailability);
            });
        }

        function areAllThemesFilled() {
            const weekInputs = document.querySelectorAll('.week-theme-input');
            const dayInputs = document.querySelectorAll('.day-theme-input');
            for (let wi of weekInputs) {
                if (!wi.value.trim()) {
                    return false;
                }
            }
            for (let di of dayInputs) {
                if (!di.value.trim()) {
                    return false;
                }
            }
            return true;
        }

        function checkAutoFillAvailability() {
            // Якщо немає чекбокса "Використовувати ШІ" або він не активний – відключаємо всі кнопки
            if (!useAICheck.checked) {
                document.getElementById('autoFillWeekThemesBtn').disabled = true;
                document.getElementById('autoFillDayThemesBtn').disabled = true;
                document.getElementById('autoFillBtn').disabled = true;
                return;
            }

            const autoFillWeekThemesBtn = document.getElementById('autoFillWeekThemesBtn');
            const autoFillDayThemesBtn = document.getElementById('autoFillDayThemesBtn');
            const autoFillBtn = document.getElementById('autoFillBtn');

            const apiKey = localStorage.getItem('geminiApiKey') || '';
            if (!apiKey.trim()) {
                autoFillWeekThemesBtn.disabled = true;
                autoFillDayThemesBtn.disabled = true;
                autoFillBtn.disabled = true;
                return;
            }

            // Доступність автозаповнення тем тижнів
            autoFillWeekThemesBtn.disabled = false;

            // Автозаповнення тем днів – якщо всі теми тижнів не пусті
            let allWeekThemesFilled = true;
            document.querySelectorAll('.week-theme-input').forEach(wi => {
                if (!wi.value.trim()) allWeekThemesFilled = false;
            });
            autoFillDayThemesBtn.disabled = !allWeekThemesFilled;

            // Повне автозаповнення (усі поля) – якщо усі теми тижнів та днів заповнені
            autoFillBtn.disabled = !areAllThemesFilled();
        }

        /****************************************************
         * ЗБЕРЕЖЕННЯ API-КЛЮЧА
         ****************************************************/
        const apiKeyInput = document.getElementById('apiKeyInput');

        // Add input event listener with debouncing
        let saveTimeout;
        apiKeyInput.addEventListener('input', function () {
            clearTimeout(saveTimeout);
            const keyInput = this.value.trim();

            saveTimeout = setTimeout(() => {
                localStorage.setItem('geminiApiKey', keyInput);
                checkAutoFillAvailability();
                updateClearApiKeyCheckbox(); // Add this line
            }, 500);
        });

        /****************************************************
         * Spinner / enable / disable main control buttons
         ****************************************************/
        function showSpinner() {
            document.getElementById('spinnerOverlay').style.display = 'block';
        }
        function hideSpinner() {
            document.getElementById('spinnerOverlay').style.display = 'none';
        }
        function disableAllButtons() {
            document.querySelectorAll('.no-print button, .no-print select, .no-print input').forEach(el => {
                el.disabled = true;
            });
        }
        function enableAllButtons() {
            // First enable all buttons except edit/save buttons
            document.querySelectorAll('.no-print button:not(.editBtn):not(.saveBtn), .no-print select, .no-print input').forEach(el => {
                el.disabled = false;
            });

            // Always enable edit/save buttons
            document.querySelectorAll('.editBtn, .saveBtn').forEach(el => {
                el.disabled = false;
            });

            // Check availability for autofill buttons
            checkAutoFillAvailability();
        }

        /****************************************************
         * АВТОЗАПОВНЕННЯ ТЕМ ТИЖНІВ
         ****************************************************/
        const autoFillWeekThemesBtn = document.getElementById('autoFillWeekThemesBtn');
        autoFillWeekThemesBtn.addEventListener('click', async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                alert('API ключ не знайдено! Спочатку збережіть ключ.');
                return;
            }

            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;
            if (!yearSelect || !monthSelect) {
                alert('Спочатку оберіть рік та місяць!');
                return;
            }

            disableAllButtons();
            showSpinner();

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const monthName = monthNamesUkr[monthIndex] || "";
            const pages = document.querySelectorAll('.page');
            const howManyWeeks = pages.length;
            if (howManyWeeks === 0) {
                alert("Спочатку створіть тижні!");
                hideSpinner();
                enableAllButtons();
                return;
            }

            // Формуємо prompt
            const promptText = `
Будь ласка, запропонуй ${howManyWeeks} актуальних коротких тем для тижнів у дитячому садочку в Україні 
на період: ${monthName} ${year}. 
Кожну тему подай з нового рядка. 
Теми мають бути креативними, але враховувати сезон та особливості виховання дітей дошкільного віку.
Якщо в тижні є державне свято України, будь ласка, врахуй його при формуванні теми тижня, але не зазначай факт врахування у назві. Свята повинні відповідати Григоріанському календарю.
Надай лише список тем, без нумерації, без коментарів.
            `.trim();

            try {
                const selectedModel = getSelectedModel();
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: promptText }]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`Помилка від API: ${response.status}`);
                }
                const data = await response.json();
                let generatedText = data.candidates[0].content.parts.at(-1).text || "";

                const lines = generatedText
                    .split(/\r?\n/)
                    .map(l => l.replace(/^\d+\)\s*/, '').trim())
                    .filter(Boolean);

                const weekInputs = document.querySelectorAll('.week-theme-input');
                for (let i = 0; i < weekInputs.length; i++) {
                    if (i < lines.length) {
                        weekInputs[i].value = lines[i];
                    }
                }

                saveGeneratedPages();
                alert("Автозаповнення тем тижнів завершено!");
            } catch (error) {
                console.error(error);
                alert("Не вдалося отримати дані від Gemini API: " + error.message);
            } finally {
                hideSpinner();
                enableAllButtons();
            }
        });

        /****************************************************
         * АВТОЗАПОВНЕННЯ ТЕМ ДНІВ (ЄДИНИЙ ЗАПИТ ДЛЯ ВСІХ)
         ****************************************************/
        const autoFillDayThemesBtn = document.getElementById('autoFillDayThemesBtn');
        autoFillDayThemesBtn.addEventListener('click', async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                alert('API ключ не знайдено! Спочатку збережіть ключ.');
                return;
            }

            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;
            if (!yearSelect || !monthSelect) {
                alert('Спочатку оберіть рік та місяць!');
                return;
            }

            disableAllButtons();
            showSpinner();

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const monthName = monthNamesUkr[monthIndex] || "";

            try {
                const allDayData = [];
                const pages = document.querySelectorAll('.page');
                for (let page of pages) {
                    const table = page.querySelector('table');
                    if (!table) continue;
                    const rows = table.querySelectorAll('tr');
                    // First tr is header, start from i=1
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const dayCell = row.querySelector('td');
                        const strong = dayCell?.querySelector('strong');
                        const dayInput = row.querySelector('.day-theme-input');
                        if (!strong || !dayInput) continue;
                        const dateAndDayText = strong.textContent.trim();
                        allDayData.push({
                            dateAndDay: dateAndDayText,
                            dayInput: dayInput
                        });
                    }
                }
                if (allDayData.length === 0) {
                    alert("Немає робочих днів для автозаповнення!");
                    hideSpinner();
                    enableAllButtons();
                    return;
                }

                const howManyDays = allDayData.length;
                const datesList = allDayData.map(item => item.dateAndDay);

                const promptText = `
Будь ласка, запропонуй ${howManyDays} різних, коротких та актуальних тем днів для дитячого садочка 
враховуючи усі ці дати (період: ${monthName} ${year}, українською мовою), 
з огляду на те, що в Україні можуть бути державні свята у деякі з цих дат. 
Свята повинні відповідати Григоріанському календарю. 
Не додавай нумерацію чи додаткові пояснення. 
Ось перелік дат для контексту:
${datesList.join('\n')}
        `.trim();

                const selectedModel = getSelectedModel();
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: promptText }]
                            }],
                            generationConfig: {
                                temperature: 1,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 8192,
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "object",
                                    properties: {
                                        response: {
                                            type: "array",
                                            items: {
                                                type: "string"
                                            }
                                        }
                                    }
                                }
                            }
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`Помилка від API: ${response.status}`);
                }
                const data = await response.json();

                // Parse the structured JSON response
                let parsedResponse;
                try {
                    const responseText = data.candidates[0].content.parts[0].text;
                    parsedResponse = JSON.parse(responseText);
                } catch (e) {
                    console.error("Error parsing JSON response:", e);
                    throw new Error("Неправильний формат відповіді від API");
                }

                // Get the array of themes from the structured response
                const themes = parsedResponse.response;

                // Apply themes to inputs
                for (let i = 0; i < allDayData.length; i++) {
                    if (i < themes.length) {
                        allDayData[i].dayInput.value = themes[i];
                    }
                }

                saveGeneratedPages();
                alert("Автозаповнення тем днів завершено!");
            } catch (error) {
                console.error(error);
                alert("Не вдалося отримати дані від Gemini API: " + error.message);
            } finally {
                hideSpinner();
                enableAllButtons();
            }
        });

        /****************************************************
         * АВТОЗАПОВНЕННЯ (ПОВНА ТАБЛИЦЯ)
         ****************************************************/
        const autoFillBtn = document.getElementById('autoFillBtn');
        autoFillBtn.addEventListener('click', async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                alert('API ключ не знайдено! Спочатку збережіть ключ.');
                return;
            }

            const yearSelect = document.getElementById('yearSelect').value;
            const monthSelect = document.getElementById('monthSelect').value;
            if (!yearSelect || !monthSelect) {
                alert('Спочатку оберіть рік та місяць!');
                return;
            }

            disableAllButtons();
            showSpinner();

            const year = parseInt(yearSelect, 10);
            const monthIndex = parseInt(monthSelect, 10) - 1;
            const monthName = monthNamesUkr[monthIndex] || "";

            try {
                const pages = document.querySelectorAll('.page');
                for (let page of pages) {
                    const weekThemeInput = page.querySelector('.week-theme-input');
                    if (!weekThemeInput) continue;
                    const weekTheme = weekThemeInput.value.trim();
                    if (!weekTheme) continue;

                    const table = page.querySelector('table');
                    if (!table) continue;
                    const rows = table.querySelectorAll('tr');
                    const dayData = [];
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const dayThemeInput = row.querySelector('.day-theme-input');
                        if (!dayThemeInput) continue;
                        const dayCell = row.querySelector('td');
                        const strong = dayCell.querySelector('strong');
                        let dayText = strong ? strong.textContent : '';
                        dayData.push({
                            dateAndDay: dayText.trim(),
                            dayTheme: dayThemeInput.value.trim()
                        });
                    }

                    const promptObj = {
                        weekTheme: weekTheme,
                        days: dayData
                    };

                    const promptText = `
Будь ласка, згенеруй план занять для дитячого садочка в Україні на тиждень (період: ${monthName} ${year}) 
за темою "${promptObj.weekTheme}". 
Для кожного дня (з його темою) вкажи 8 коротких активностей (українською мовою), кожна відповідає одній 
з освітніх ліній (1: «Особистість дитини», 2: «Дитина в соціумі», 3: «Дитина в природному довкіллі», 
4: «Дитина у світі культури», 5: «Мовлення дитини», 6: «Дитина в сенсорно-математичному просторі», 
7: «Гра дитини», 8: + ще одна на вибір). 
Просимо підлаштувати активності з урахуванням пори року та державних свят України. Свята повинні відповідати Григоріанському календарю.
Формат відповіді подай у JSON, де ключ "tableData" містить масив із об’єктами:
{
  "dateAndDay": "наприклад '01.01 (Середа)'",
  "dayTheme": "наприклад 'Пригоди сніговика'",
  "lines": [
    "короткий опис активності 1",
    "короткий опис активності 2",
    ... (усього 8 пунктів)
  ]
}

Важливо! Відповіді в масив "lines" з описом активностей не повинні містити нумерацію. Не додавай опис освітньої лінії в результат.

Ось перелік днів тижня і теми днів, які треба включити у план (масив у JSON):
${JSON.stringify(promptObj.days, null, 2)}
                    `.trim();

                    const selectedModel = getSelectedModel();
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: promptText }]
                                }]
                            })
                        }
                    );
                    if (!response.ok) {
                        throw new Error(`Помилка від API: ${response.status}`);
                    }
                    const data = await response.json();
                    let generatedText = data.candidates[0].content.parts.at(-1).text || "";

                    // Припустимо, що у відповіді прийде JSON у полі "tableData"
                    let cleaned = generatedText
                        .replace(/^```json\s*/i, '')
                        .replace('```', '')
                        .trim();

                    let parsedData = null;
                    try {
                        parsedData = JSON.parse(cleaned);
                    } catch (e) {
                        console.error("Помилка парсингу JSON:", e);
                        console.log("Відповідь від Gemini:", generatedText);
                        continue;
                    }

                    if (!parsedData || !parsedData.tableData) {
                        console.warn("У розпарсеному JSON немає tableData.");
                        continue;
                    }

                    // Заповнюємо рядки
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const dayCell = row.querySelector('td');
                        if (!dayCell) continue;
                        const strong = dayCell.querySelector('strong');
                        if (!strong) continue;
                        const currentDateAndDay = strong.textContent.trim();

                        const dayEntry = parsedData.tableData.find(entry => {
                            return entry.dateAndDay && entry.dateAndDay.includes(currentDateAndDay);
                        });

                        if (dayEntry && Array.isArray(dayEntry.lines)) {
                            const columns = row.querySelectorAll('td');
                            for (let colIndex = 1; colIndex < columns.length; colIndex++) {
                                if (dayEntry.lines[colIndex - 1]) {
                                    columns[colIndex].textContent = dayEntry.lines[colIndex - 1];
                                }
                            }
                        }
                    }
                }

                saveGeneratedPages();
                alert("Повне автозаповнення таблиць завершено!");
            } catch (error) {
                console.error(error);
                alert("Не вдалося отримати дані від Gemini API: " + error.message);
            } finally {
                hideSpinner();
                enableAllButtons();
            }
        });

        /****************************************************
         * Заміна input на текст при друку, а потім відновлення
         ****************************************************/
        const printBtn = document.getElementById('btnPrint');
        printBtn.addEventListener('click', function () {
            const dayInputs = document.querySelectorAll('.day-theme-input');
            const weekInputs = document.querySelectorAll('.week-theme-input');

            const replacedElements = [];
            function replaceInputWithSpan(input) {
                const span = document.createElement('span');
                span.textContent = input.value.trim();
                replacedElements.push({ original: input, temp: span });
                input.parentNode.replaceChild(span, input);
            }

            dayInputs.forEach(input => replaceInputWithSpan(input));
            weekInputs.forEach(input => replaceInputWithSpan(input));

            window.print();

            replacedElements.forEach(({ original, temp }) => {
                temp.parentNode.replaceChild(original, temp);
            });
        });

        /****************************************************
         * КНОПКА ІНСТРУКЦІЇ
         ****************************************************/
        const btnInstructions = document.getElementById('btnInstructions');
        btnInstructions.addEventListener('click', function () {
            window.open('instructions.html', '_blank');
        });
    </script>

</body>

</html>